{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templater - Django</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}?v=20250811">
    <link rel="alternate icon" href="{% static 'favicon.ico' %}?v=20250811">
    <link rel="mask-icon" href="{% static 'favicon.svg' %}?v=20250811" color="#3B82F6">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/i7idxd1ss3d8d8dhyb63zcdozq8cgno2k9bymb5vrdaq8ynp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="bg-gray-100 pb-12">
    <!-- Navigation -->
    <nav class="bg-white shadow mb-6">
        <div class="max-w-4xl mx-auto px-6">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Email Templater</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'email_dashboard' %}" class="text-gray-600 hover:text-gray-900">Email Monitor</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Email Campaign Manager</h2>
                    <p class="text-gray-600">Send targeted email campaigns to your contacts with real-time tracking</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="refreshIndicator" class="hidden">
                        <div class="flex items-center text-sm text-blue-600">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            Updating stats...
                        </div>
                    </div>
                    <button id="manualRefresh" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100" title="Refresh statistics">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contact Statistics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-8 gap-3 md:gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-gray-100 rounded-lg">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Total Contacts</p>
                        <p id="totalContacts" class="text-lg font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-blue-100 rounded-lg">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Not Sent Yet</p>
                        <p id="notSentContacts" class="text-lg font-bold text-blue-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-yellow-100 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Sent</p>
                        <p id="sentContacts" class="text-lg font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-green-100 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Delivered</p>
                        <p id="deliveredContacts" class="text-lg font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-purple-100 rounded-lg">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Opened</p>
                        <p id="openedContacts" class="text-lg font-bold text-purple-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-indigo-100 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Clicked</p>
                        <p id="clickedContacts" class="text-lg font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-red-100 rounded-lg">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Bounced</p>
                        <p id="bouncedFailedContacts" class="text-lg font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3">
                <div class="flex items-center">
                    <div class="p-1.5 bg-orange-100 rounded-lg">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01"></path>
                        </svg>
                    </div>
                    <div class="ml-2">
                        <p class="text-xs font-medium text-gray-500">Complained</p>
                        <p id="complainedContacts" class="text-lg font-bold text-orange-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Setup -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Campaign Setup</h3>
        
        <!-- Contact Filter Selection -->
        <div class="grid md:grid-cols-4 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Target Audience</label>
                <select id="contactFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="not_sent">📧 Not Sent Yet</option>
                    <option value="all">👥 All Contacts</option>
                    <option value="sent">📤 Previously Sent</option>
                    <option value="delivered">✅ Delivered</option>
                    <option value="opened">👁️ Opened</option>
                    <option value="clicked">🔗 Clicked</option>
                    <option value="bounced">⚠️ Bounced</option>
                    <option value="failed">❌ Failed</option>
                    <option value="custom">🎯 Custom Selection</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Choose which contacts to target based on their engagement status</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Selection Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <div class="relative">
                        <input type="number" id="contactRangeStart" min="1" placeholder="Start ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">From ID</label>
                    </div>
                    <div class="relative">
                        <input type="number" id="contactRangeEnd" min="1" placeholder="End ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">To ID</label>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm text-gray-500">Select contacts by ID range (e.g., 1 to 100)</p>
                    <button type="button" id="clearRange" class="text-sm text-gray-400 hover:text-gray-600" title="Clear range">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p id="rangeError" class="text-sm text-red-500 mt-1 hidden">Invalid range specified</p>
                <div id="rangeInfo" class="text-sm text-blue-600 mt-1 hidden">
                    <span id="rangeCount">0</span> contacts in range
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sender Email</label>
                <select id="senderSelect" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="horizoneurope">📧 roland.zonai@horizoneurope.io</option>
                    <option value="horizon_eu">📧 roland.zonai@horizon.eu.com</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Choose which email address to send from</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Subject</label>
                <input type="text" id="emailSubject" value="EU Grant Advisory Platform - Beta Testing Invitation" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Enter your email subject">
            </div>
        </div>
        
        <!-- Custom Contact Selection (Hidden by default) -->
        <div id="customContactSelection" class="bg-gray-50 rounded-lg p-6 mb-6 hidden">
            <h4 class="text-lg font-medium text-gray-900 mb-4">🎯 Custom Contact Selection</h4>
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="contactSearch" placeholder="Search by name, email, company..." 
                           class="pl-10 w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <!-- Selection Controls -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex space-x-2">
                    <button type="button" id="selectAllFiltered" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200">
                        Select All Visible
                    </button>
                    <button type="button" id="deselectAll" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Deselect All
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
            
            <!-- Contacts List -->
            <div id="contactsList" class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                <div id="contactsLoading" class="p-4 text-center text-gray-500">
                    Loading contacts...
                </div>
            </div>
        </div>
        
        <!-- Email Template -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Template</label>
           
            <textarea id="emailTemplate" class="w-full"></textarea>
        </div>
        
        <!-- Send Button -->
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-500">
                <span id="csvStatus">Ready to send emails</span>
            </div>
            <button id="sendEmailsTracking" 
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Send Campaign</span>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="messages" class="mt-6"></div>
        </div>
    </div>

    <script>
        let columns = [];
        let editorInitialized = false;
        let allContacts = [];
        let filteredContacts = [];
        let selectedContacts = new Set();

        // Initialize TinyMCE editor
        function initializeEditor() {
            // Check if TinyMCE is available
            if (typeof tinymce === 'undefined') {
                console.error('TinyMCE not loaded. Using fallback textarea.');
                return;
            }

            tinymce.init({
                selector: '#emailTemplate',
                height: 400,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | formatselect | ' +
                        'bold italic underline strikethrough | alignleft aligncenter ' +
                        'alignright alignjustify | outdent indent | numlist bullist | ' +
                        'forecolor backcolor removeformat | link table | ' +
                        'fontsize fontfamily | code preview help',
                font_family_formats: 'Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Georgia=georgia,palatino,serif; Helvetica=helvetica,arial,sans-serif; Times New Roman=times new roman,times,serif; Verdana=verdana,geneva,sans-serif',
                font_size_formats: '8pt 10pt 12pt 14pt 16pt 18pt 24pt 36pt 48pt',
                content_style: 'body { font-family:Arial,Helvetica,sans-serif; font-size:14px; margin: 16px; }',
                branding: false,
                promotion: false,
                setup: function (editor) {
                    editor.on('init', function () {
                        editorInitialized = true;
                        console.log('TinyMCE editor initialized successfully');
                        // Load template content after editor is ready
                        loadLastTemplate();
                    });
                }
            }).catch(function(error) {
                console.error('TinyMCE initialization failed:', error);
            });
        }

        // Load the last used template
        function loadLastTemplate() {
            fetch('/api/get_template/')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log('No saved template found, using default');
                        return;
                    }
                    
                    // Set the subject
                    document.getElementById('emailSubject').value = data.subject;
                    
                    // Set the template content
                    if (editorInitialized && tinymce.get('emailTemplate')) {
                        // TinyMCE is ready, set content through editor
                        tinymce.get('emailTemplate').setContent(data.content);
                    } else {
                        // TinyMCE not ready yet, set textarea value directly
                        document.getElementById('emailTemplate').value = data.content;
                        
                        // Also try to set it after a delay in case TinyMCE initializes later
                        setTimeout(() => {
                            if (tinymce.get('emailTemplate')) {
                                tinymce.get('emailTemplate').setContent(data.content);
                            }
                        }, 1000);
                    }
                    
                    console.log('Loaded last used template');
                })
                .catch(error => {
                    console.log('Failed to load template:', error);
                });
        }

        // Load contact stats automatically on page load
        function loadContactStats() {
            // Show refresh indicator
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.classList.remove('hidden');
            }
            
            // Fetch contact statistics from our API
            fetch('/monitor/api/contact_stats/')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('csvStatus').textContent = 'Error loading contact stats';
                        console.error('Contact stats error:', data.error);
                        return;
                    }
                    
                    // Store the stats globally for filter updates
                    window.contactStats = data;
                    
                    // Update the statistics cards
                    document.getElementById('totalContacts').textContent = data.total_contacts || 0;
                    document.getElementById('notSentContacts').textContent = data.not_sent || 0;
                    document.getElementById('sentContacts').textContent = data.sent || 0;
                    document.getElementById('deliveredContacts').textContent = data.delivered || 0;
                    document.getElementById('openedContacts').textContent = data.opened || 0;
                    document.getElementById('clickedContacts').textContent = data.clicked || 0;
                    document.getElementById('bouncedFailedContacts').textContent = (data.bounced || 0) + (data.failed || 0);
                    document.getElementById('complainedContacts').textContent = data.complained || 0;
                    
                    // Update status message based on current filter
                    updateStatusMessage();
                })
                .catch(error => {
                    document.getElementById('csvStatus').textContent = 'Ready to send emails';
                    console.error('Failed to load contact stats:', error);
                    
                    // Set default values
                    document.getElementById('totalContacts').textContent = '0';
                    document.getElementById('notSentContacts').textContent = '0';
                    document.getElementById('sentContacts').textContent = '0';
                    document.getElementById('deliveredContacts').textContent = '0';
                    document.getElementById('openedContacts').textContent = '0';
                    document.getElementById('clickedContacts').textContent = '0';
                    document.getElementById('bouncedFailedContacts').textContent = '0';
                    document.getElementById('complainedContacts').textContent = '0';
                })
                .finally(() => {
                    // Hide refresh indicator
                    if (refreshIndicator) {
                        refreshIndicator.classList.add('hidden');
                    }
                });
        }

        // Update status message based on selected filter
        function updateStatusMessage() {
            if (!window.contactStats) return;
            
            const filter = document.getElementById('contactFilter').value;
            
            // Handle custom selection differently
            if (filter === 'custom') {
                const selectedCount = selectedContacts.size;
                document.getElementById('csvStatus').textContent = selectedCount > 0 ? 
                    `Ready to send emails to ${selectedCount} selected contacts` : 
                    'Select contacts from the list below';
                
                // Hide range controls for custom selection
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'none';
                return;
            } else {
                // Show range controls for other filters
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'block';
            }
            
            const stats = window.contactStats;
            const rangeStartInput = document.getElementById('contactRangeStart');
            const rangeEndInput = document.getElementById('contactRangeEnd');
            const rangeError = document.getElementById('rangeError');
            const rangeInfo = document.getElementById('rangeInfo');
            const rangeCount = document.getElementById('rangeCount');
            
            const startId = rangeStartInput.value ? parseInt(rangeStartInput.value) : null;
            const endId = rangeEndInput.value ? parseInt(rangeEndInput.value) : null;
            
            let count = 0;
            let filterName = '';
            
            switch(filter) {
                case 'all':
                    count = stats.total_contacts;
                    filterName = 'all contacts';
                    break;
                case 'not_sent':
                    count = stats.not_sent;
                    filterName = 'contacts not sent yet';
                    break;
                case 'sent':
                    count = stats.sent;
                    filterName = 'previously sent contacts';
                    break;
                case 'delivered':
                    count = stats.delivered;
                    filterName = 'delivered contacts';
                    break;
                case 'opened':
                    count = stats.opened;
                    filterName = 'opened contacts';
                    break;
                case 'clicked':
                    count = stats.clicked;
                    filterName = 'clicked contacts';
                    break;
                case 'bounced':
                    count = stats.bounced;
                    filterName = 'bounced contacts';
                    break;
                case 'failed':
                    count = stats.failed;
                    filterName = 'failed contacts';
                    break;
                case 'complained':
                    count = stats.complained;
                    filterName = 'complained contacts';
                    break;
                default:
                    count = stats.total_contacts;
                    filterName = 'contacts';
            }
            
            // Validate the range
            let isValidRange = true;
            let rangeSize = count;
            
            if (startId || endId) {
                // Check if both values are provided and valid
                if (startId && endId) {
                    if (startId > endId) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'Start ID must be less than or equal to End ID';
                        rangeInfo.classList.add('hidden');
                    } else if (startId < 1 || endId < 1) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'IDs must be greater than 0';
                        rangeInfo.classList.add('hidden');
                    } else {
                        rangeSize = endId - startId + 1;
                        rangeError.classList.add('hidden');
                        rangeInfo.classList.remove('hidden');
                        rangeCount.textContent = rangeSize;
                    }
                } else if (startId && !endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `${startId} onwards`;
                } else if (!startId && endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `1 to ${endId}`;
                    rangeSize = endId;
                }
                
                // Add visual feedback for inputs
                if (isValidRange) {
                    rangeStartInput.classList.remove('border-red-500');
                    rangeStartInput.classList.add('border-gray-300');
                    rangeEndInput.classList.remove('border-red-500');
                    rangeEndInput.classList.add('border-gray-300');
                } else {
                    rangeStartInput.classList.add('border-red-500');
                    rangeStartInput.classList.remove('border-gray-300');
                    rangeEndInput.classList.add('border-red-500');
                    rangeEndInput.classList.remove('border-gray-300');
                }
            } else {
                rangeError.classList.add('hidden');
                rangeInfo.classList.add('hidden');
                rangeStartInput.classList.remove('border-red-500');
                rangeStartInput.classList.add('border-gray-300');
                rangeEndInput.classList.remove('border-red-500');
                rangeEndInput.classList.add('border-gray-300');
            }
            
            // Update status message
            if (startId || endId) {
                if (isValidRange) {
                    if (startId && endId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID ${startId}-${endId} (${rangeSize} contacts) from ${filterName}`;
                    } else if (startId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts from ID ${startId} onwards from ${filterName}`;
                    } else {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID 1-${endId} from ${filterName}`;
                    }
                } else {
                    document.getElementById('csvStatus').textContent = `Invalid range specified for ${filterName}`;
                }
            } else {
                document.getElementById('csvStatus').textContent = `Ready to send emails to ${count} ${filterName}`;
            }
            
            // Store validation state globally
            window.isRangeValid = isValidRange;
        }

        // Load contacts for custom selection
        function loadContactsForSelection() {
            fetch('/monitor/api/contacts/')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading contacts:', data.error);
                        return;
                    }
                    
                    allContacts = data.contacts || [];
                    filteredContacts = [...allContacts];
                    renderContactsList();
                })
                .catch(error => {
                    console.error('Failed to load contacts:', error);
                    document.getElementById('contactsLoading').textContent = 'Failed to load contacts';
                });
        }

        // Render contacts list
        function renderContactsList() {
            const contactsList = document.getElementById('contactsList');
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div class="p-4 text-center text-gray-500">No contacts found</div>';
                return;
            }
            
            const contactsHTML = filteredContacts.map(contact => {
                const isSelected = selectedContacts.has(contact.id);
                const statusColor = getStatusColor(contact.email_status);
                
                return `
                    <div class="contact-item p-3 border-b border-gray-200 hover:bg-gray-50 ${isSelected ? 'bg-blue-50' : ''}">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="contact_${contact.id}" 
                                   class="contact-checkbox mr-3" 
                                   ${isSelected ? 'checked' : ''}
                                   data-contact-id="${contact.id}">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-900">
                                            ${contact.first_name} ${contact.last_name}
                                        </p>
                                        <p class="text-sm text-gray-600">${contact.email}</p>
                                        ${contact.company_name ? `<p class="text-sm text-gray-500">${contact.company_name}</p>` : ''}
                                        ${contact.job_title ? `<p class="text-xs text-gray-400">${contact.job_title}</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                            ${contact.email_status.replace('_', ' ').toUpperCase()}
                                        </span>
                                        ${contact.location_country ? `<p class="text-xs text-gray-400 mt-1">${contact.location_country}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsList.innerHTML = contactsHTML;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const contactId = parseInt(this.dataset.contactId);
                    if (this.checked) {
                        selectedContacts.add(contactId);
                    } else {
                        selectedContacts.delete(contactId);
                    }
                    updateSelectedCount();
                    updateStatusMessage();
                });
            });
        }

        // Get status color for contact
        function getStatusColor(status) {
            switch(status) {
                case 'not_sent': return 'bg-gray-100 text-gray-800';
                case 'sent': return 'bg-blue-100 text-blue-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'opened': return 'bg-purple-100 text-purple-800';
                case 'clicked': return 'bg-indigo-100 text-indigo-800';
                case 'bounced': return 'bg-yellow-100 text-yellow-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'complained': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedContacts.size;
        }

        // Filter contacts based on search
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = [...allContacts];
            } else {
                const term = searchTerm.toLowerCase();
                filteredContacts = allContacts.filter(contact => 
                    contact.first_name.toLowerCase().includes(term) ||
                    contact.last_name.toLowerCase().includes(term) ||
                    contact.email.toLowerCase().includes(term) ||
                    (contact.company_name && contact.company_name.toLowerCase().includes(term)) ||
                    (contact.job_title && contact.job_title.toLowerCase().includes(term)) ||
                    (contact.location_country && contact.location_country.toLowerCase().includes(term))
                );
            }
            renderContactsList();
        }

        // Toggle custom contact selection visibility
        function toggleCustomSelection(show) {
            const customSection = document.getElementById('customContactSelection');
            if (show) {
                customSection.classList.remove('hidden');
                if (allContacts.length === 0) {
                    loadContactsForSelection();
                }
            } else {
                customSection.classList.add('hidden');
                selectedContacts.clear();
                updateSelectedCount();
            }
        }

        // Show message to user
        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageClass = isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700';
            messagesDiv.innerHTML = `<div class="${messageClass} px-4 py-3 rounded mb-4">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Load contacts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            loadContactStats();
            loadLastTemplate();
            
            // Set up periodic refresh of contact stats every 30 seconds
            setInterval(loadContactStats, 30000);
            
            // Manual refresh button
            document.getElementById('manualRefresh').addEventListener('click', function() {
                loadContactStats();
            });
            
            // Clear range button functionality
            document.getElementById('clearRange').addEventListener('click', function() {
                document.getElementById('contactRangeStart').value = '';
                document.getElementById('contactRangeEnd').value = '';
                updateStatusMessage();
            });
            
            // Range input change handlers
            document.getElementById('contactRangeStart').addEventListener('input', updateStatusMessage);
            document.getElementById('contactRangeEnd').addEventListener('input', updateStatusMessage);
            
            // Contact filter change handler
            document.getElementById('contactFilter').addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                toggleCustomSelection(isCustom);
                updateStatusMessage();
            });
            
            // Contact search handler
            document.getElementById('contactSearch').addEventListener('input', function() {
                filterContacts(this.value);
            });
            
            // Select all filtered contacts
            document.getElementById('selectAllFiltered').addEventListener('click', function() {
                filteredContacts.forEach(contact => {
                    selectedContacts.add(contact.id);
                });
                renderContactsList();
                updateSelectedCount();
                updateStatusMessage();
            });
            
            // Deselect all contacts
            document.getElementById('deselectAll').addEventListener('click', function() {
                selectedContacts.clear();
                renderContactsList();
                updateSelectedCount();
                updateStatusMessage();
            });
        });

        // Update status message when filter or range changes
        document.getElementById('contactFilter').addEventListener('change', updateStatusMessage);

        // Send emails with tracking
        document.getElementById('sendEmailsTracking').addEventListener('click', function() {
            const contactFilter = document.getElementById('contactFilter').value;
            const subject = document.getElementById('emailSubject').value;
            const rangeStart = document.getElementById('contactRangeStart').value;
            const rangeEnd = document.getElementById('contactRangeEnd').value;
            
            // Handle custom selection
            if (contactFilter === 'custom') {
                if (selectedContacts.size === 0) {
                    showMessage('Please select at least one contact to send emails to', true);
                    return;
                }
            } else {
                // Validate range for non-custom filters
                if (!window.isRangeValid && (rangeStart || rangeEnd)) {
                    showMessage('Please enter a valid ID range', true);
                    return;
                }
            }
            
            // Get content from TinyMCE editor
            let template = '';
            if (editorInitialized && tinymce.get('emailTemplate')) {
                template = tinymce.get('emailTemplate').getContent();
            } else {
                template = document.getElementById('emailTemplate').value;
            }

            if (!template.trim() || template === '<p></p>') {
                showMessage('Please enter an email template', true);
                return;
            }

            // Show loading state
            const button = document.getElementById('sendEmailsTracking');
            const originalText = button.textContent;
            button.textContent = 'Sending Emails...';
            button.disabled = true;

            const requestBody = {
                template: template,
                subject: subject,
                sender: document.getElementById('senderSelect').value
            };
            
            // Handle custom selection vs filter-based selection
            if (contactFilter === 'custom') {
                requestBody.selected_contact_ids = Array.from(selectedContacts);
            } else {
                requestBody.contact_filter = contactFilter;
                // Add range if specified and valid
                if ((rangeStart || rangeEnd) && window.isRangeValid) {
                    if (rangeStart) requestBody.contact_range_start = parseInt(rangeStart);
                    if (rangeEnd) requestBody.contact_range_end = parseInt(rangeEnd);
                }
            }

            fetch('/send_emails/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, true);
                } else {
                    let message = data.message;
                    if (data.failed_count > 0) {
                        message += `<br><strong>Failed emails:</strong> ${data.failed_count}`;
                        if (data.failed_emails && data.failed_emails.length > 0) {
                            message += '<br><small>' + data.failed_emails.slice(0, 3).join(', ') + '</small>';
                        }
                    }
                    showMessage(message);
                    
                    // Refresh contact stats after sending - multiple attempts to catch webhook updates
                    setTimeout(loadContactStats, 500);   // Quick refresh
                    setTimeout(loadContactStats, 2000);  // Medium refresh 
                    setTimeout(loadContactStats, 5000);  // Longer refresh to catch webhook updates
                    setTimeout(loadContactStats, 10000); // Final refresh for slow webhooks
                    
                    // If custom selection, refresh the contacts list to show updated status
                    if (contactFilter === 'custom') {
                        setTimeout(() => {
                            loadContactsForSelection();
                            selectedContacts.clear();
                            updateSelectedCount();
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                showMessage('Error: ' + error, true);
            })
            .finally(() => {
                // Reset button state
                button.textContent = originalText;
                button.disabled = false;
            });
        });
    </script>
</body>
</html>
