{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templater - Django</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}?v=20250811">
    <link rel="alternate icon" href="{% static 'favicon.ico' %}?v=20250811">
    <link rel="mask-icon" href="{% static 'favicon.svg' %}?v=20250811" color="#3B82F6">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
   
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/i7idxd1ss3d8d8dhyb63zcdozq8cgno2k9bymb5vrdaq8ynp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="bg-gray-100 pb-12">
    <!-- Navigation -->
    <nav class="bg-white shadow mb-6">
        <div class="max-w-4xl mx-auto px-6">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Email Templater</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'contacts_list' %}" class="text-gray-600 hover:text-gray-900" onclick="updateContactsLinkWithSender(event, this)">Email Monitor</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Email Campaign Manager</h2>
                    <p class="text-gray-600">Send targeted email campaigns to your contacts with real-time tracking</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="refreshIndicator" class="hidden">
                        <div class="flex items-center text-sm text-blue-600">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            Updating stats...
                        </div>
                    </div>
                    <div id="autoSaveIndicator" class="hidden">
                        <div class="flex items-center text-sm text-green-600">
                            <div class="w-2 h-2 bg-green-600 rounded-full mr-2"></div>
                            Auto-saved
                        </div>
                    </div>
                    <button id="manualRefresh" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100" title="Refresh statistics">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contact Statistics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-9 gap-3 md:gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-gray-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Contact Records</p>
                        <p id="totalContacts" class="text-lg font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-indigo-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Email Events</p>
                        <p id="totalEmailEvents" class="text-lg font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('not_sent')" title="View all contacts that haven't been sent emails yet">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-blue-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Not Sent Yet</p>
                        <p id="notSentContacts" class="text-lg font-bold text-blue-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('sent')" title="View all contacts that have been sent emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-yellow-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Sent</p>
                        <p id="sentContacts" class="text-lg font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('delivered')" title="View all contacts with delivered emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-green-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Delivered</p>
                        <p id="deliveredContacts" class="text-lg font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('opened')" title="View all contacts who opened emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-purple-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Opened</p>
                        <p id="openedContacts" class="text-lg font-bold text-purple-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('clicked')" title="View all contacts who clicked links in emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-indigo-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Clicked</p>
                        <p id="clickedContacts" class="text-lg font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('bounced')" title="View all contacts with bounced emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-red-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Bounced</p>
                        <p id="bouncedFailedContacts" class="text-lg font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('complained')" title="View all contacts who complained about emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-orange-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Complained</p>
                        <p id="complainedContacts" class="text-lg font-bold text-orange-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('failed')" title="View all contacts with failed email deliveries">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-red-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Failed</p>
                        <p id="failedContacts" class="text-lg font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Explanation -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-blue-900 mb-1">Statistics Explanation</h4>
                    <div class="text-sm text-blue-800">
                        <span class="font-semibold">Contact Records:</span> People/companies in your database ‚Ä¢ 
                        <span class="font-semibold">Email Events:</span> Tracked email activities (sent, delivered, opened, etc.) ‚Ä¢ 
                        <span class="font-semibold">Status Counts:</span> Based on latest email events from this sender
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Sender Management -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Email Sender Management</h3>
                <div class="flex space-x-3">
                    <button id="exportSendersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Export JSON</span>
                    </button>
                    <button id="importSendersBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>Import JSON</span>
                    </button>
                    <button id="addSenderBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Add New Sender</span>
                    </button>
                </div>
            </div>

            <!-- Email Senders List -->
            <div id="sendersContainer" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    Loading email senders...
                </div>
            </div>
        </div>

        <!-- Campaign Setup -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Campaign Setup</h3>
        
        <!-- Contact Filter Selection -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Target Audience</label>
                <select id="contactFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="not_sent">üìß Not Sent Yet</option>
                    <option value="all">üë• All Contacts</option>
                    <option value="sent">üì§ Previously Sent</option>
                    <option value="delivered">‚úÖ Delivered</option>
                    <option value="opened">üëÅÔ∏è Opened</option>
                    <option value="clicked">üîó Clicked</option>
                    <option value="bounced">‚ö†Ô∏è Bounced</option>
                    <option value="failed">‚ùå Failed</option>
                    <option value="custom">üéØ Custom Selection</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Choose which contacts to target based on their engagement status</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
                <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">üìÅ All Categories</option>
                    <option disabled>Loading categories...</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Filter contacts by their assigned category</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Selection Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <div class="relative">
                        <input type="number" id="contactRangeStart" min="1" placeholder="Start ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">From ID</label>
                    </div>
                    <div class="relative">
                        <input type="number" id="contactRangeEnd" min="1" placeholder="End ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">To ID</label>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm text-gray-500">Select contacts by ID range (e.g., 1 to 100)</p>
                    <button type="button" id="clearRange" class="text-sm text-gray-400 hover:text-gray-600" title="Clear range">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p id="rangeError" class="text-sm text-red-500 mt-1 hidden">Invalid range specified</p>
                <div id="rangeInfo" class="text-sm text-blue-600 mt-1 hidden">
                    <span id="rangeCount">0</span> contacts in range
                </div>
            </div>
        </div>
        
        <!-- Email Subject -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Subject</label>
            <input type="text" id="emailSubject" value="EU Grant Advisory Platform - Beta Testing Invitation" 
                   class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Enter your email subject">
        </div>
        
        <!-- Custom Contact Selection (Hidden by default) -->
        <div id="customContactSelection" class="bg-gray-50 rounded-lg p-6 mb-6 hidden">
            <h4 class="text-lg font-medium text-gray-900 mb-4">üéØ Custom Contact Selection</h4>
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="contactSearch" placeholder="Search by name, email, company..." 
                           class="pl-10 w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <!-- Selection Controls -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex space-x-2">
                    <button type="button" id="selectAllFiltered" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200">
                        Select All Visible
                    </button>
                    <button type="button" id="deselectAll" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Deselect All
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
            
            <!-- Contacts List -->
            <div id="contactsList" class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                <div id="contactsLoading" class="p-4 text-center text-gray-500">
                    Loading contacts...
                </div>
            </div>
        </div>
        
        <!-- Email Template -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Template</label>
           
            <textarea id="emailTemplate" class="w-full"></textarea>
        </div>
        
        <!-- Send Button -->
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-500">
                <span id="csvStatus">Ready to send emails</span>
            </div>
            <button id="sendEmailsTracking" 
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Send Campaign</span>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="messages" class="mt-6"></div>
        </div>
    </div>

    <script>
        let columns = [];
        let editorInitialized = false;
        let allContacts = [];
        let filteredContacts = [];
        let selectedContacts = new Set();

        // Initialize TinyMCE editor
        function initializeEditor() {
            // Check if TinyMCE is available
            if (typeof tinymce === 'undefined') {
                console.error('TinyMCE not loaded. Using fallback textarea.');
                return;
            }

            tinymce.init({
                selector: '#emailTemplate',
                height: 400,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | formatselect | ' +
                        'bold italic underline strikethrough | alignleft aligncenter ' +
                        'alignright alignjustify | outdent indent | numlist bullist | ' +
                        'forecolor backcolor removeformat | link table | ' +
                        'fontsize fontfamily | code preview help',
                font_family_formats: 'Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Georgia=georgia,palatino,serif; Helvetica=helvetica,arial,sans-serif; Times New Roman=times new roman,times,serif; Verdana=verdana,geneva,sans-serif',
                font_size_formats: '8pt 10pt 12pt 14pt 16pt 18pt 24pt 36pt 48pt',
                content_style: 'body { font-family:Arial,Helvetica,sans-serif; font-size:14px; margin: 16px; }',
                branding: false,
                promotion: false,
                setup: function (editor) {
                    editor.on('init', function () {
                        editorInitialized = true;
                        console.log('TinyMCE editor initialized successfully');
                        // Load template content after editor is ready
                        loadLastTemplate();
                    });
                }
            }).catch(function(error) {
                console.error('TinyMCE initialization failed:', error);
            });
        }

        // Load the last used template for a specific sender
        function loadLastTemplate(sender = null) {
            const currentSender = sender || getSavedSender();
            
            // Prevent excessive API calls with cooldown
            const now = Date.now();
            const templateKey = `loadTemplate_${currentSender}`;
            if (window.lastTemplateLoadTime && window.lastTemplateLoadTime[templateKey] && 
                (now - window.lastTemplateLoadTime[templateKey]) < 3000) {
                console.log('Skipping template reload - too frequent');
                return;
            }
            
            if (!window.lastTemplateLoadTime) {
                window.lastTemplateLoadTime = {};
            }
            window.lastTemplateLoadTime[templateKey] = now;
            
            fetch(`/api/get_template/?sender=${currentSender}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log(`No saved template found for sender ${currentSender}, using default`);
                        return;
                    }
                    
                    // Set the subject
                    document.getElementById('emailSubject').value = data.subject;
                    
                    // Set the template content
                    if (editorInitialized && tinymce.get('emailTemplate')) {
                        // TinyMCE is ready, set content through editor
                        tinymce.get('emailTemplate').setContent(data.content);
                    } else {
                        // TinyMCE not ready yet, set textarea value directly
                        document.getElementById('emailTemplate').value = data.content;
                        
                        // Also try to set it after a delay in case TinyMCE initializes later
                        setTimeout(() => {
                            if (tinymce.get('emailTemplate')) {
                                tinymce.get('emailTemplate').setContent(data.content);
                            }
                        }, 1000);
                    }
                    
                    console.log(`Loaded last used template for sender: ${currentSender}`);
                })
                .catch(error => {
                    console.log('Failed to load template:', error);
                });
        }

        // Save the current template for a specific sender
        function saveCurrentTemplate(sender = null) {
            const currentSender = sender || getSavedSender();
            const subject = document.getElementById('emailSubject').value;
            
            let content = '';
            if (editorInitialized && tinymce.get('emailTemplate')) {
                content = tinymce.get('emailTemplate').getContent();
            } else {
                content = document.getElementById('emailTemplate').value;
            }
            
            if (!content.trim() && !subject.trim()) {
                return; // Don't save empty templates
            }
            
            // Prevent duplicate saves with same content
            const templateKey = `${currentSender}_${subject}_${content}`;
            if (window.lastSavedTemplateKey === templateKey) {
                return; // Same content, skip save
            }
            
            window.lastSavedTemplateKey = templateKey;
            
            fetch('/api/save_template/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: subject,
                    content: content,
                    sender: currentSender
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Failed to save template:', data.error);
                } else {
                    console.log(`Template saved for sender: ${currentSender}`);
                }
            })
            .catch(error => {
                console.error('Failed to save template:', error);
                // Reset the saved key so we can try again
                window.lastSavedTemplateKey = null;
            });
        }

        // Sender management functions
        function getSavedSender() {
            return localStorage.getItem('selectedSender') || 'horizoneurope';
        }

        function saveSender(sender) {
            localStorage.setItem('selectedSender', sender);
        }

        function getSavedCategory() {
            return localStorage.getItem('selectedCategory') || '';
        }

        function saveCategory(category) {
            localStorage.setItem('selectedCategory', category);
        }

        function applySenderToUI() {
            const savedSender = getSavedSender();
            const senderSelect = document.getElementById('senderSelect');
            if (senderSelect) {
                senderSelect.value = savedSender;
            }
            
            // Update UI elements based on sender
            updateUIForSender(savedSender);
        }

        function applyCategoryToUI() {
            const savedCategory = getSavedCategory();
            const categorySelect = document.getElementById('categoryFilter');
            if (categorySelect && savedCategory) {
                categorySelect.value = savedCategory;
                // Trigger status message update to show the restored category selection
                updateStatusMessage();
            }
        }

        function updateUIForSender(sender) {
            // Update page title to show current sender
            const senderInfo = getSenderInfo(sender);
            document.title = `Email Campaign Manager - ${senderInfo.name}`;
            
            // Add sender selector after the header section
            const headerSection = document.querySelector('.bg-white.rounded-lg.shadow-sm.p-6.mb-6');
            if (headerSection && !document.getElementById('senderIndicator')) {
                const senderIndicator = document.createElement('div');
                senderIndicator.id = 'senderIndicator';
                senderIndicator.className = 'bg-blue-50 border border-blue-200 rounded-lg shadow-sm p-4 mb-6';
                senderIndicator.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="p-2 bg-blue-100 rounded-lg flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-blue-900 mb-1">Active Sender Account</p>
                            <select id="activeSenderSelect" class="w-full text-lg font-semibold text-blue-700 bg-white border border-blue-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer hover:bg-blue-50 transition-colors min-w-max">
                                <option value="">Loading senders...</option>
                            </select>
                        </div>
                    </div>
                `;
                headerSection.parentNode.insertBefore(senderIndicator, headerSection.nextSibling);
                
                // Add event listener to the new selector
                const activeSenderSelect = document.getElementById('activeSenderSelect');
                activeSenderSelect.value = sender;
                activeSenderSelect.addEventListener('change', function() {
                    const oldSender = getSavedSender();
                    const newSender = this.value;
                    
                    // Save current template for the old sender before switching
                    saveCurrentTemplate(oldSender);
                    
                    // Switch to new sender
                    saveSender(newSender);
                    
                    // Update the main sender selector to match
                    const mainSenderSelect = document.getElementById('senderSelect');
                    if (mainSenderSelect) {
                        mainSenderSelect.value = newSender;
                    }
                    
                    // Load template for new sender
                    setTimeout(() => {
                        loadLastTemplate(newSender);
                    }, 200); // Small delay to ensure save completes first
                    
                    // Refresh data for new sender
                    loadContactStats();
                    
                    // If custom selection is open, reload contacts for new sender
                    const customSection = document.getElementById('customContactSelection');
                    if (!customSection.classList.contains('hidden')) {
                        selectedContacts.clear();
                        updateSelectedCount();
                        loadContactsForSelection();
                    }
                    
                    console.log(`Switched from ${getSenderInfo(oldSender).name} to ${getSenderInfo(newSender).name}`);
                });
            } else if (document.getElementById('senderIndicator')) {
                const activeSenderSelect = document.getElementById('activeSenderSelect');
                if (activeSenderSelect) {
                    activeSenderSelect.value = sender;
                }
            }
        }

        function getSenderInfo(sender) {
            const senderMap = {
                'horizoneurope': { name: 'roland.zonai@horizoneurope.io', domain: 'horizoneurope.io' },
                'horizon_eu': { name: 'roland.zonai@horizon.eu.com', domain: 'horizon.eu.com' }
            };
            return senderMap[sender] || senderMap['horizoneurope'];
        }

        // Load contact stats automatically on page load
        function loadContactStats(forceReload = false) {
            // Prevent excessive API calls with cooldown (but allow forced reloads)
            const now = Date.now();
            if (!forceReload && window.lastStatsLoadTime && (now - window.lastStatsLoadTime) < 2000) {
                console.log('Skipping stats reload - too frequent');
                return;
            }
            window.lastStatsLoadTime = now;
            
            // Show refresh indicator
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.classList.remove('hidden');
            }
            
            // Get current sender for filtering
            const currentSender = getSavedSender();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            // Build URL with parameters
            let url = `/monitor/api/contact_stats/?sender=${currentSender}`;
            if (categoryFilter) {
                url += `&category=${encodeURIComponent(categoryFilter)}`;
            }
            
            console.log('Loading stats with URL:', url);
            
            // Fetch contact statistics from our API with sender and category filter
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('csvStatus').textContent = 'Error loading contact stats';
                        console.error('Contact stats error:', data.error);
                        return;
                    }
                    
                    // Store the stats globally for filter updates
                    window.contactStats = data;
                    
                    console.log('Stats updated:', {
                        category: data.category_filter || 'All Categories',
                        total_contacts: data.total_contacts,
                        not_sent: data.not_sent
                    });
                    
                    // Update the statistics cards
                    document.getElementById('totalContacts').textContent = data.total_contacts || 0;
                    document.getElementById('totalEmailEvents').textContent = data.total_email_events || 0;
                    document.getElementById('notSentContacts').textContent = data.not_sent || 0;
                    document.getElementById('sentContacts').textContent = data.sent || 0;
                    document.getElementById('deliveredContacts').textContent = data.delivered || 0;
                    document.getElementById('openedContacts').textContent = data.opened || 0;
                    document.getElementById('clickedContacts').textContent = data.clicked || 0;
                    document.getElementById('bouncedFailedContacts').textContent = (data.bounced || 0) + (data.failed || 0);
                    document.getElementById('complainedContacts').textContent = data.complained || 0;
                    document.getElementById('failedContacts').textContent = data.failed || 0;
                    
                    // Update status message based on current filter
                    updateStatusMessage();
                })
                .catch(error => {
                    document.getElementById('csvStatus').textContent = 'Ready to send emails';
                    console.error('Failed to load contact stats:', error);
                    
                    // Set default values
                    document.getElementById('totalContacts').textContent = '0';
                    document.getElementById('totalEmailEvents').textContent = '0';
                    document.getElementById('notSentContacts').textContent = '0';
                    document.getElementById('sentContacts').textContent = '0';
                    document.getElementById('deliveredContacts').textContent = '0';
                    document.getElementById('openedContacts').textContent = '0';
                    document.getElementById('clickedContacts').textContent = '0';
                    document.getElementById('bouncedFailedContacts').textContent = '0';
                    document.getElementById('complainedContacts').textContent = '0';
                    document.getElementById('failedContacts').textContent = '0';
                })
                .finally(() => {
                    // Hide refresh indicator
                    if (refreshIndicator) {
                        refreshIndicator.classList.add('hidden');
                    }
                });
        }

        // Load categories for the category filter dropdown
        function loadCategories() {
            fetch('/monitor/api/categories/')
                .then(response => response.json())
                .then(data => {
                    const categorySelect = document.getElementById('categoryFilter');
                    // Clear existing options except the first one
                    categorySelect.innerHTML = '<option value="">üìÅ All Categories</option>';
                    
                    if (data.success && data.categories && data.categories.length > 0) {
                        data.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.category_id;
                            option.textContent = `${category.category_name} (${category.category_id}) - ${category.contact_count} contacts`;
                            categorySelect.appendChild(option);
                        });
                        console.log('Loaded', data.categories.length, 'categories for email sending');
                        
                        // Restore saved category selection after loading categories
                        applyCategoryToUI();
                    } else {
                        console.log('No categories found for email sending');
                        // Add option indicating no categories
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No categories available yet';
                        option.disabled = true;
                        categorySelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading categories for email sending:', error);
                    const categorySelect = document.getElementById('categoryFilter');
                    categorySelect.innerHTML = '<option value="">üìÅ All Categories</option><option value="" disabled>Error loading categories</option>';
                });
        }

        // Update status message based on selected filter
        function updateStatusMessage() {
            if (!window.contactStats) return;
            
            const filter = document.getElementById('contactFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            // Handle custom selection differently
            if (filter === 'custom') {
                const selectedCount = selectedContacts.size;
                const categoryText = categoryFilter ? ` from category "${categoryFilter}"` : '';
                document.getElementById('csvStatus').textContent = selectedCount > 0 ? 
                    `Ready to send emails to ${selectedCount} selected contacts${categoryText}` : 
                    `Select contacts from the list below${categoryText}`;
                
                // Hide range controls for custom selection
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'none';
                return;
            } else {
                // Show range controls for other filters
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'block';
            }
            
            const stats = window.contactStats;
            const rangeStartInput = document.getElementById('contactRangeStart');
            const rangeEndInput = document.getElementById('contactRangeEnd');
            const rangeError = document.getElementById('rangeError');
            const rangeInfo = document.getElementById('rangeInfo');
            const rangeCount = document.getElementById('rangeCount');
            
            const startId = rangeStartInput.value ? parseInt(rangeStartInput.value) : null;
            const endId = rangeEndInput.value ? parseInt(rangeEndInput.value) : null;
            
            let count = 0;
            let filterName = '';
            
            switch(filter) {
                case 'all':
                    count = stats.total_contacts;
                    filterName = 'all contacts';
                    break;
                case 'not_sent':
                    count = stats.not_sent;
                    filterName = 'contacts not sent yet';
                    break;
                case 'sent':
                    count = stats.sent;
                    filterName = 'previously sent contacts';
                    break;
                case 'delivered':
                    count = stats.delivered;
                    filterName = 'delivered contacts';
                    break;
                case 'opened':
                    count = stats.opened;
                    filterName = 'opened contacts';
                    break;
                case 'clicked':
                    count = stats.clicked;
                    filterName = 'clicked contacts';
                    break;
                case 'bounced':
                    count = stats.bounced;
                    filterName = 'bounced contacts';
                    break;
                case 'failed':
                    count = stats.failed;
                    filterName = 'failed contacts';
                    break;
                case 'complained':
                    count = stats.complained;
                    filterName = 'complained contacts';
                    break;
                default:
                    count = stats.total_contacts;
                    filterName = 'contacts';
            }
            
            // Validate the range
            let isValidRange = true;
            let rangeSize = count;
            
            if (startId || endId) {
                // Check if both values are provided and valid
                if (startId && endId) {
                    if (startId > endId) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'Start ID must be less than or equal to End ID';
                        rangeInfo.classList.add('hidden');
                    } else if (startId < 1 || endId < 1) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'IDs must be greater than 0';
                        rangeInfo.classList.add('hidden');
                    } else {
                        rangeSize = endId - startId + 1;
                        rangeError.classList.add('hidden');
                        rangeInfo.classList.remove('hidden');
                        rangeCount.textContent = rangeSize;
                    }
                } else if (startId && !endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `${startId} onwards`;
                } else if (!startId && endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `1 to ${endId}`;
                    rangeSize = endId;
                }
                
                // Add visual feedback for inputs
                if (isValidRange) {
                    rangeStartInput.classList.remove('border-red-500');
                    rangeStartInput.classList.add('border-gray-300');
                    rangeEndInput.classList.remove('border-red-500');
                    rangeEndInput.classList.add('border-gray-300');
                } else {
                    rangeStartInput.classList.add('border-red-500');
                    rangeStartInput.classList.remove('border-gray-300');
                    rangeEndInput.classList.add('border-red-500');
                    rangeEndInput.classList.remove('border-gray-300');
                }
            } else {
                rangeError.classList.add('hidden');
                rangeInfo.classList.add('hidden');
                rangeStartInput.classList.remove('border-red-500');
                rangeStartInput.classList.add('border-gray-300');
                rangeEndInput.classList.remove('border-red-500');
                rangeEndInput.classList.add('border-gray-300');
            }
            
            // Update status message
            const categoryText = categoryFilter ? ` from category "${categoryFilter}"` : '';
            if (startId || endId) {
                if (isValidRange) {
                    if (startId && endId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID ${startId}-${endId} (${rangeSize} contacts) from ${filterName}${categoryText}`;
                    } else if (startId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts from ID ${startId} onwards from ${filterName}${categoryText}`;
                    } else {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID 1-${endId} from ${filterName}${categoryText}`;
                    }
                } else {
                    document.getElementById('csvStatus').textContent = `Invalid range specified for ${filterName}${categoryText}`;
                }
            } else {
                document.getElementById('csvStatus').textContent = `Ready to send emails to ${count} ${filterName}${categoryText}`;
            }
            
            // Store validation state globally
            window.isRangeValid = isValidRange;
        }

        // Load contacts for custom selection
        function loadContactsForSelection() {
            const currentSender = getSavedSender();
            
            fetch(`/monitor/api/contacts/?sender=${currentSender}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading contacts:', data.error);
                        return;
                    }
                    
                    allContacts = data.contacts || [];
                    filteredContacts = [...allContacts];
                    renderContactsList();
                })
                .catch(error => {
                    console.error('Failed to load contacts:', error);
                    document.getElementById('contactsLoading').textContent = 'Failed to load contacts';
                });
        }

        // Render contacts list
        function renderContactsList() {
            const contactsList = document.getElementById('contactsList');
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div class="p-4 text-center text-gray-500">No contacts found</div>';
                return;
            }
            
            const contactsHTML = filteredContacts.map(contact => {
                const isSelected = selectedContacts.has(contact.id);
                const statusColor = getStatusColor(contact.email_status);
                
                return `
                    <div class="contact-item p-3 border-b border-gray-200 hover:bg-gray-50 ${isSelected ? 'bg-blue-50' : ''}">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="contact_${contact.id}" 
                                   class="contact-checkbox mr-3" 
                                   ${isSelected ? 'checked' : ''}
                                   data-contact-id="${contact.id}">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-900">
                                            ${contact.first_name} ${contact.last_name}
                                        </p>
                                        <p class="text-sm text-gray-600">${contact.email}</p>
                                        ${contact.company_name ? `<p class="text-sm text-gray-500">${contact.company_name}</p>` : ''}
                                        ${contact.job_title ? `<p class="text-xs text-gray-400">${contact.job_title}</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                            ${contact.email_status.replace('_', ' ').toUpperCase()}
                                        </span>
                                        ${contact.location_country ? `<p class="text-xs text-gray-400 mt-1">${contact.location_country}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsList.innerHTML = contactsHTML;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const contactId = parseInt(this.dataset.contactId);
                    if (this.checked) {
                        selectedContacts.add(contactId);
                    } else {
                        selectedContacts.delete(contactId);
                    }
                    updateSelectedCount();
                    updateStatusMessage();
                });
            });
        }

        // Get status color for contact
        function getStatusColor(status) {
            switch(status) {
                case 'not_sent': return 'bg-gray-100 text-gray-800';
                case 'sent': return 'bg-blue-100 text-blue-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'opened': return 'bg-purple-100 text-purple-800';
                case 'clicked': return 'bg-indigo-100 text-indigo-800';
                case 'bounced': return 'bg-yellow-100 text-yellow-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'complained': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedContacts.size;
        }

        // Filter contacts based on search
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = [...allContacts];
            } else {
                const term = searchTerm.toLowerCase();
                filteredContacts = allContacts.filter(contact => 
                    contact.first_name.toLowerCase().includes(term) ||
                    contact.last_name.toLowerCase().includes(term) ||
                    contact.email.toLowerCase().includes(term) ||
                    (contact.company_name && contact.company_name.toLowerCase().includes(term)) ||
                    (contact.job_title && contact.job_title.toLowerCase().includes(term)) ||
                    (contact.location_country && contact.location_country.toLowerCase().includes(term))
                );
            }
            renderContactsList();
        }

        // Toggle custom contact selection visibility
        function toggleCustomSelection(show) {
            const customSection = document.getElementById('customContactSelection');
            if (show) {
                customSection.classList.remove('hidden');
                if (allContacts.length === 0) {
                    loadContactsForSelection();
                }
            } else {
                customSection.classList.add('hidden');
                selectedContacts.clear();
                updateSelectedCount();
            }
        }

        // Show message to user
        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageClass = isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700';
            messagesDiv.innerHTML = `<div class="${messageClass} px-4 py-3 rounded mb-4">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Load contacts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load available senders first, then apply saved sender
            loadAvailableSenders();
            
            initializeEditor();
            loadContactStats();
            loadLastTemplate();
            loadCategories(); // Load categories for the category filter
            loadEmailSenders(); // Load email senders for management
            
            // Set up periodic refresh of contact stats every 30 seconds
            setInterval(loadContactStats, 30000);
            
            // Manual refresh button
            document.getElementById('manualRefresh').addEventListener('click', function() {
                loadContactStats();
            });
            
            // Sender selection change handler (only if element exists)
            const senderSelect = document.getElementById('senderSelect');
            if (senderSelect) {
                senderSelect.addEventListener('change', function() {
                    const newSender = this.value;
                    saveSender(newSender);
                    updateUIForSender(newSender);
                    
                    // Refresh data for new sender
                    loadContactStats();
                    
                    // If custom selection is open, reload contacts for new sender
                    const customSection = document.getElementById('customContactSelection');
                    if (!customSection.classList.contains('hidden')) {
                        selectedContacts.clear();
                        updateSelectedCount();
                        loadContactsForSelection();
                    }
                    
                    console.log(`Switched to sender: ${getSenderInfo(newSender).name}`);
                });
            }
            
            // Clear range button functionality
            document.getElementById('clearRange').addEventListener('click', function() {
                document.getElementById('contactRangeStart').value = '';
                document.getElementById('contactRangeEnd').value = '';
                updateStatusMessage();
            });
            
            // Range input change handlers
            document.getElementById('contactRangeStart').addEventListener('input', updateStatusMessage);
            document.getElementById('contactRangeEnd').addEventListener('input', updateStatusMessage);
            
            // Contact filter change handler
            document.getElementById('contactFilter').addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                toggleCustomSelection(isCustom);
                updateStatusMessage();
            });
            
            // Category filter change handler
            document.getElementById('categoryFilter').addEventListener('change', function() {
                console.log('Category filter changed to:', this.value);
                saveCategory(this.value); // Save the selected category
                loadContactStats(true); // Force reload stats for the new category
                updateStatusMessage();
            });
            
            // Contact search handler
            document.getElementById('contactSearch').addEventListener('input', function() {
                filterContacts(this.value);
            });
            
            // Select all filtered contacts
            document.getElementById('selectAllFiltered').addEventListener('click', function() {
                filteredContacts.forEach(contact => {
                    selectedContacts.add(contact.id);
                });
                renderContactsList();
                updateSelectedCount();
                updateStatusMessage();
            });
            
            // Deselect all contacts
            document.getElementById('deselectAll').addEventListener('click', function() {
                selectedContacts.clear();
                renderContactsList();
                updateSelectedCount();
                updateStatusMessage();
            });

            // Email Sender Management Event Listeners
            document.getElementById('addSenderBtn').addEventListener('click', function() {
                showSenderModal();
            });

            document.getElementById('exportSendersBtn').addEventListener('click', function() {
                exportSendersToJson();
            });

            document.getElementById('importSendersBtn').addEventListener('click', function() {
                showImportModal();
            });

            document.getElementById('closeSenderModal').addEventListener('click', hideSenderModal);
            document.getElementById('cancelSenderBtn').addEventListener('click', hideSenderModal);

            document.getElementById('closeImportModal').addEventListener('click', hideImportModal);
            document.getElementById('cancelImportBtn').addEventListener('click', hideImportModal);

            document.getElementById('importForm').addEventListener('submit', function(e) {
                e.preventDefault();
                importSendersFromJson();
            });

            document.getElementById('senderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = {};
                
                // Convert FormData to regular object
                for (let [key, value] of formData.entries()) {
                    if (key === 'is_active') {
                        data[key] = true; // Checkbox is checked
                    } else if (value.trim() !== '') {
                        data[key] = value.trim();
                    }
                }
                
                // If not checked, is_active should be false
                if (!data.hasOwnProperty('is_active')) {
                    data.is_active = false;
                }

                // For editing, don't send empty API key or webhook secret
                if (currentEditingSender && (!data.api_key || data.api_key === '')) {
                    delete data.api_key;
                }
                if (currentEditingSender && (!data.webhook_secret || data.webhook_secret === '')) {
                    delete data.webhook_secret;
                }

                saveSender(data);
            });

            // Close modal when clicking outside
            document.getElementById('senderModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideSenderModal();
                }
            });

            // Auto-save template when subject or content changes
            let autoSaveTimeout;
            let lastAutoSaveTime = 0;
            const AUTO_SAVE_COOLDOWN = 5000; // 5 seconds minimum between saves
            
            // Auto-save subject changes
            document.getElementById('emailSubject').addEventListener('input', function() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    const now = Date.now();
                    if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                        saveCurrentTemplate();
                        showAutoSaveIndicator();
                        lastAutoSaveTime = now;
                    }
                }, 2000); // Save 2 seconds after user stops typing
            });
            
            // Also save subject when user clicks away (blur event)
            document.getElementById('emailSubject').addEventListener('blur', function() {
                clearTimeout(autoSaveTimeout);
                const now = Date.now();
                if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                    saveCurrentTemplate();
                    showAutoSaveIndicator();
                    lastAutoSaveTime = now;
                }
            });
            
            // Auto-save template content changes (for TinyMCE)
            function setupAutoSaveForEditor() {
                if (editorInitialized && tinymce.get('emailTemplate')) {
                    tinymce.get('emailTemplate').on('input', function() {
                        clearTimeout(autoSaveTimeout);
                        autoSaveTimeout = setTimeout(() => {
                            const now = Date.now();
                            if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                                saveCurrentTemplate();
                                showAutoSaveIndicator();
                                lastAutoSaveTime = now;
                            }
                        }, 3000); // Save 3 seconds after user stops typing
                    });
                    
                    // Also save on blur (when user clicks away)
                    tinymce.get('emailTemplate').on('blur', function() {
                        clearTimeout(autoSaveTimeout);
                        const now = Date.now();
                        if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                            saveCurrentTemplate();
                            showAutoSaveIndicator();
                            lastAutoSaveTime = now;
                        }
                    });
                } else {
                    // Retry setup if editor not ready yet
                    setTimeout(setupAutoSaveForEditor, 1000);
                }
            }
            
            // Show auto-save indicator
            function showAutoSaveIndicator() {
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    indicator.innerHTML = '<div class="flex items-center text-sm text-green-600"><div class="w-2 h-2 bg-green-600 rounded-full mr-2"></div>Auto-saved</div>';
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                    }, 3000);
                }
            }
            
            // Set up auto-save when editor is ready
            setTimeout(setupAutoSaveForEditor, 2000);
        });

        // Send emails with tracking
        document.getElementById('sendEmailsTracking').addEventListener('click', function() {
            const contactFilter = document.getElementById('contactFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const subject = document.getElementById('emailSubject').value;
            const rangeStart = document.getElementById('contactRangeStart').value;
            const rangeEnd = document.getElementById('contactRangeEnd').value;
            
            // Handle custom selection
            if (contactFilter === 'custom') {
                if (selectedContacts.size === 0) {
                    showMessage('Please select at least one contact to send emails to', true);
                    return;
                }
            } else {
                // Validate range for non-custom filters
                if (!window.isRangeValid && (rangeStart || rangeEnd)) {
                    showMessage('Please enter a valid ID range', true);
                    return;
                }
            }
            
            // Get content from TinyMCE editor
            let template = '';
            if (editorInitialized && tinymce.get('emailTemplate')) {
                template = tinymce.get('emailTemplate').getContent();
            } else {
                template = document.getElementById('emailTemplate').value;
            }

            if (!template.trim() || template === '<p></p>') {
                showMessage('Please enter an email template', true);
                return;
            }

            // Show loading state
            const button = document.getElementById('sendEmailsTracking');
            const originalText = button.textContent;
            button.textContent = 'Sending Emails...';
            button.disabled = true;

            const requestBody = {
                template: template,
                subject: subject,
                sender: getSavedSender() // Use saved sender instead of dropdown value
            };
            
            // Add category filter if specified
            if (categoryFilter) {
                requestBody.category_filter = categoryFilter;
            }
            
            // Handle custom selection vs filter-based selection
            if (contactFilter === 'custom') {
                requestBody.selected_contact_ids = Array.from(selectedContacts);
            } else {
                requestBody.contact_filter = contactFilter;
                // Add range if specified and valid
                if ((rangeStart || rangeEnd) && window.isRangeValid) {
                    if (rangeStart) requestBody.contact_range_start = parseInt(rangeStart);
                    if (rangeEnd) requestBody.contact_range_end = parseInt(rangeEnd);
                }
            }

            fetch('/send_emails/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, true);
                } else {
                    let message = data.message;
                    if (data.failed_count > 0) {
                        message += `<br><strong>Failed emails:</strong> ${data.failed_count}`;
                        if (data.failed_emails && data.failed_emails.length > 0) {
                            message += '<br><small>' + data.failed_emails.slice(0, 3).join(', ') + '</small>';
                        }
                    }
                    showMessage(message);
                    
                    // Refresh contact stats after sending - multiple attempts to catch webhook updates
                    setTimeout(loadContactStats, 500);   // Quick refresh
                    setTimeout(loadContactStats, 2000);  // Medium refresh 
                    setTimeout(loadContactStats, 5000);  // Longer refresh to catch webhook updates
                    setTimeout(loadContactStats, 10000); // Final refresh for slow webhooks
                    
                    // If custom selection, refresh the contacts list to show updated status
                    if (contactFilter === 'custom') {
                        setTimeout(() => {
                            loadContactsForSelection();
                            selectedContacts.clear();
                            updateSelectedCount();
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                showMessage('Error: ' + error, true);
            })
            .finally(() => {
                // Reset button state
                button.textContent = originalText;
                button.disabled = false;
            });
        });

        // Function to navigate to contacts page with status filter
        function navigateToContactsWithStatus(status) {
            const currentSender = getSavedSender();
            const currentCategory = document.getElementById('categoryFilter').value;
            const url = new URL('/monitor/', window.location.origin);
            url.searchParams.set('status', status);
            url.searchParams.set('sender', currentSender);
            if (currentCategory) {
                url.searchParams.set('category', currentCategory);
            }
            window.location.href = url.toString();
        }

        // Function to update contacts link with current sender
        function updateContactsLinkWithSender(event, linkElement) {
            event.preventDefault();
            const currentSender = getSavedSender();
            const currentCategory = document.getElementById('categoryFilter').value;
            const url = new URL('/monitor/', window.location.origin);
            url.searchParams.set('sender', currentSender);
            if (currentCategory) {
                url.searchParams.set('category', currentCategory);
            }
            window.location.href = url.toString();
        }

        // Email Sender Management Functions
        let currentEditingSender = null;

        function loadEmailSenders() {
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayEmailSenders(data.senders);
                        updateSenderDropdowns(data.senders);
                    } else {
                        console.error('Failed to load email senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading email senders:', error);
                });
        }

        function displayEmailSenders(senders) {
            const container = document.getElementById('sendersContainer');
            
            if (senders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>No email senders configured yet.</p>
                        <p class="text-sm">Click "Add New Sender" to create your first email configuration.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = senders.map(sender => `
                <div class="border border-gray-200 rounded-lg p-4 ${sender.is_active ? 'bg-white' : 'bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-medium text-gray-900">${sender.name}</h4>
                                <span class="px-2 py-1 text-xs rounded-full ${sender.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                    ${sender.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Key:</span> ${sender.key}
                            </p>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Email:</span> ${sender.email}
                            </p>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Domain:</span> ${sender.domain}
                            </p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500 mt-2">
                                <span class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1 ${sender.has_api_key ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    API Key ${sender.has_api_key ? 'Set' : 'Missing'}
                                </span>
                                <span class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1 ${sender.has_webhook_url ? 'bg-green-500' : 'bg-gray-300'}"></div>
                                    Webhook ${sender.has_webhook_url ? 'Set' : 'Not Set'}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editSender(${sender.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Edit
                            </button>
                            <button onclick="deleteSender(${sender.id}, '${sender.name}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showSenderModal(sender = null) {
            currentEditingSender = sender;
            const modal = document.getElementById('senderModal');
            const title = document.getElementById('senderModalTitle');
            const form = document.getElementById('senderForm');
            
            if (sender) {
                title.textContent = 'Edit Email Sender';
                document.getElementById('senderKey').value = sender.key;
                document.getElementById('senderKey').disabled = true;
                document.getElementById('senderName').value = sender.name;
                document.getElementById('senderEmail').value = sender.email;
                document.getElementById('senderDomain').value = sender.domain;
                document.getElementById('senderIsActive').checked = sender.is_active;
                document.getElementById('senderApiKey').placeholder = 'Leave blank to keep current key';
                document.getElementById('senderWebhookSecret').placeholder = 'Leave blank to keep current secret';
            } else {
                title.textContent = 'Add Email Sender';
                form.reset();
                document.getElementById('senderKey').disabled = false;
                document.getElementById('senderApiKey').placeholder = 're_...';
                document.getElementById('senderWebhookSecret').placeholder = 'whsec_...';
            }
            
            modal.classList.remove('hidden');
        }

        function hideSenderModal() {
            document.getElementById('senderModal').classList.add('hidden');
            document.getElementById('senderForm').reset();
            currentEditingSender = null;
        }

        function editSender(senderId) {
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const sender = data.senders.find(s => s.id === senderId);
                        if (sender) {
                            showSenderModal(sender);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching sender:', error);
                    alert('Error loading sender details');
                });
        }

        function deleteSender(senderId, senderName) {
            if (confirm(`Are you sure you want to delete the email sender "${senderName}"?`)) {
                fetch(`/monitor/api/email_senders/${senderId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadEmailSenders(); // Reload the sender management list
                        loadAvailableSenders(); // Refresh the dropdown options
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting sender:', error);
                    alert('Error deleting sender');
                });
            }
        }

        function updateSenderDropdowns(senders) {
            // Update main sender selector if it exists
            const senderSelect = document.getElementById('senderSelect');
            if (senderSelect) {
                const currentValue = senderSelect.value;
                senderSelect.innerHTML = senders
                    .filter(sender => sender.is_active)
                    .map(sender => `<option value="${sender.key}">${sender.name}</option>`)
                    .join('');
                
                // Restore previous selection if still available
                if (currentValue && senders.find(s => s.key === currentValue && s.is_active)) {
                    senderSelect.value = currentValue;
                }
            }

            // Update active sender select
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                const currentValue = activeSenderSelect.value;
                activeSenderSelect.innerHTML = senders
                    .filter(sender => sender.is_active)
                    .map(sender => `<option value="${sender.key}">${sender.name}</option>`)
                    .join('');
                
                // Restore previous selection if still available
                if (currentValue && senders.find(s => s.key === currentValue && s.is_active)) {
                    activeSenderSelect.value = currentValue;
                }
            }
        }

        function loadAvailableSenders() {
            fetch('/monitor/api/email_senders/available/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSenderDropdownsFromAvailable(data.senders);
                    } else {
                        console.error('Failed to load available senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading available senders:', error);
                });
        }

        function updateSenderDropdownsFromAvailable(senders) {
            // Update active sender select
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                const currentValue = activeSenderSelect.value;
                activeSenderSelect.innerHTML = senders
                    .map(sender => `<option value="${sender.key}">${sender.display_name}</option>`)
                    .join('');
                
                // Set saved sender or default to first available
                const savedSender = getSavedSender();
                if (savedSender && senders.find(s => s.key === savedSender)) {
                    activeSenderSelect.value = savedSender;
                } else if (senders.length > 0) {
                    activeSenderSelect.value = senders[0].key;
                    saveSender(senders[0].key); // Save the default selection
                }
            }
        }

        function saveSender(formData) {
            const isEditing = currentEditingSender !== null;
            const url = isEditing 
                ? `/monitor/api/email_senders/${currentEditingSender.id}/update/`
                : '/monitor/api/email_senders/create/';
            const method = isEditing ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    hideSenderModal();
                    loadEmailSenders(); // Reload the sender management list
                    loadAvailableSenders(); // Refresh the dropdown options
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving sender:', error);
                alert('Error saving sender');
            });
        }

        // JSON Import/Export Functions
        function exportSendersToJson() {
            fetch('/monitor/api/email_senders/export/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create downloadable JSON file
                        const jsonString = JSON.stringify(data.senders, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        // Create download link
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `email_senders_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Email senders exported successfully!');
                    } else {
                        alert('Error exporting email senders: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error exporting email senders:', error);
                    alert('Error exporting email senders');
                });
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            // Clear previous data
            document.getElementById('jsonImportData').value = '';
            document.getElementById('replaceExisting').checked = false;
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function importSendersFromJson() {
            const jsonData = document.getElementById('jsonImportData').value.trim();
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!jsonData) {
                alert('Please enter JSON data');
                return;
            }
            
            try {
                // Validate JSON format
                const parsedData = JSON.parse(jsonData);
                
                // Prepare the data for import
                const importData = {
                    senders: parsedData.senders || parsedData, // Support both formats
                    replace_existing: replaceExisting
                };
                
                // Validate that we have senders data
                if (!importData.senders || Object.keys(importData.senders).length === 0) {
                    alert('No valid senders data found in JSON');
                    return;
                }
                
                // Send import request
                fetch('/monitor/api/email_senders/import/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(importData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hideImportModal();
                        loadEmailSenders(); // Reload the sender management list
                        loadAvailableSenders(); // Refresh the dropdown options
                        
                        let message = data.message;
                        if (data.errors && data.errors.length > 0) {
                            message += '\n\nErrors encountered:\n' + data.errors.join('\n');
                        }
                        alert(message);
                    } else {
                        alert('Error importing senders: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error importing senders:', error);
                    alert('Error importing senders');
                });
                
            } catch (e) {
                alert('Invalid JSON format: ' + e.message);
            }
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.split('; ')
                           .find(row => row.startsWith('csrftoken='))
                           ?.split('=')[1] || '';
        }
    </script>

    <!-- Email Sender Management Modal -->
    <div id="senderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="senderModalTitle" class="text-lg font-medium text-gray-900">Add Email Sender</h3>
                    <button id="closeSenderModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="senderForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sender Key *</label>
                        <input type="text" id="senderKey" name="key" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., my_company" required>
                        <p class="text-xs text-gray-500 mt-1">Unique identifier for this sender</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name *</label>
                        <input type="text" id="senderName" name="name" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., My Company Name" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                        <input type="email" id="senderEmail" name="email" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., noreply@mycompany.com" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Domain *</label>
                        <input type="text" id="senderDomain" name="domain" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., mycompany.com" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Resend API Key *</label>
                        <input type="password" id="senderApiKey" name="api_key" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="re_..." required>
                        <p class="text-xs text-gray-500 mt-1">Your Resend API key for this sender</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                        <input type="url" id="senderWebhookUrl" name="webhook_url" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="https://yoursite.com/webhook/">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webhook Secret</label>
                        <input type="password" id="senderWebhookSecret" name="webhook_secret" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="whsec_...">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="senderIsActive" name="is_active" checked
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="senderIsActive" class="ml-2 block text-sm text-gray-900">Active</label>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelSenderBtn" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg">
                            Cancel
                        </button>
                        <button type="submit" id="saveSenderBtn" 
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">
                            Save Sender
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JSON Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Import Email Senders from JSON</h3>
                    <button id="closeImportModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">JSON Format Expected:</h4>
                    <pre class="text-xs text-blue-800 bg-blue-100 p-2 rounded overflow-x-auto"><code>{
  "senders": {
    "sender_key": {
      "email": "email@domain.com",
      "name": "Display Name", 
      "api_key": "your_api_key",
      "domain": "domain.com",
      "webhook_url": "optional_webhook_url",
      "webhook_secret": "optional_webhook_secret"
    }
  },
  "replace_existing": false
}</code></pre>
                </div>
                
                <form id="importForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">JSON Data</label>
                        <textarea id="jsonImportData" name="jsonData" 
                                  class="w-full h-64 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                  placeholder="Paste your JSON data here..." required></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="replaceExisting" name="replaceExisting" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="replaceExisting" class="ml-2 block text-sm text-gray-700">
                            Replace existing senders (deactivate all current senders)
                        </label>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelImportBtn" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg">
                            Cancel
                        </button>
                        <button type="submit" id="importJsonBtn" 
                                class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg">
                            Import Senders
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
