{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templater - Django</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}?v=20250811">
    <link rel="alternate icon" href="{% static 'favicon.ico' %}?v=20250811">
    <link rel="mask-icon" href="{% static 'favicon.svg' %}?v=20250811" color="#3B82F6">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
   
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/i7idxd1ss3d8d8dhyb63zcdozq8cgno2k9bymb5vrdaq8ynp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="bg-gray-100 pb-12">

    <!-- Navigation -->
    <nav class="bg-white shadow mb-6">
        <div class="max-w-4xl mx-auto px-6">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Email Templater</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'contacts_list' %}" class="text-gray-600 hover:text-gray-900" onclick="updateContactsLinkWithSender(event, this)">Email Monitor</a>
                    <a href="/sender-management/" class="text-gray-600 hover:text-gray-900">Sender Management</a>
                </div>
            </div>
        </div>
    </nav>


    <div class="max-w-6xl mx-auto">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Email Campaign Manager</h2>
                    <p class="text-gray-600">Send targeted email campaigns to your contacts with real-time tracking</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="refreshIndicator" class="hidden">
                        <div class="flex items-center text-sm text-blue-600">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            Updating stats...
                        </div>
                    </div>
                    <div id="autoSaveIndicator" class="hidden">
                        <div class="flex items-center text-sm text-green-600">
                            <div class="w-2 h-2 bg-green-600 rounded-full mr-2"></div>
                            Auto-saved
                        </div>
                    </div>
                    <button id="manualRefresh" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100" title="Refresh statistics">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contact Statistics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-9 gap-3 md:gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-gray-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Contact Records</p>
                        <p id="totalContacts" class="text-lg font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-indigo-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Email Events</p>
                        <p id="totalEmailEvents" class="text-lg font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('not_sent')" title="View all contacts that haven't been sent emails yet">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-blue-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Not Sent Yet</p>
                        <p id="notSentContacts" class="text-lg font-bold text-blue-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('sent')" title="View all contacts that have been sent emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-yellow-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Sent</p>
                        <p id="sentContacts" class="text-lg font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('delivered')" title="View all contacts with delivered emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-green-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Delivered</p>
                        <p id="deliveredContacts" class="text-lg font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('opened')" title="View all contacts who opened emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-purple-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Opened</p>
                        <p id="openedContacts" class="text-lg font-bold text-purple-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('clicked')" title="View all contacts who clicked links in emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-indigo-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Clicked</p>
                        <p id="clickedContacts" class="text-lg font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('bounced')" title="View all contacts with bounced emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-red-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Bounced</p>
                        <p id="bouncedFailedContacts" class="text-lg font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('complained')" title="View all contacts who complained about emails">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-orange-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Complained</p>
                        <p id="complainedContacts" class="text-lg font-bold text-orange-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-3 min-h-[80px] flex items-center cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="navigateToContactsWithStatus('failed')" title="View all contacts with failed email deliveries">
                <div class="flex items-center w-full">
                    <div class="p-1.5 bg-red-100 rounded-lg flex-shrink-0">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                    <div class="ml-2 min-w-0 flex-1">
                        <p class="text-xs font-medium text-gray-500 truncate">Failed</p>
                        <p id="failedContacts" class="text-lg font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Explanation -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <!-- Move sender selector here, just above Campaign Setup -->
        <div id="senderIndicator" class="bg-blue-50 border border-blue-200 rounded-lg shadow-sm p-4 mb-6">
            <div class="flex items-center space-x-4">
                <div class="p-2 bg-blue-100 rounded-lg flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-blue-900 mb-1">Active Sender Account</p>
                    <select id="activeSenderSelect" class="w-full text-lg font-semibold text-blue-700 bg-white border border-blue-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer hover:bg-blue-50 transition-colors min-w-max">
                        <option value="">Loading senders...</option>
                    </select>
                </div>
            </div>
        </div>
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-blue-900 mb-1">Statistics Explanation</h4>
                    <div class="text-sm text-blue-800">
                        <span class="font-semibold">Contact Records:</span> People/companies in your database ‚Ä¢ 
                        <span class="font-semibold">Email Events:</span> Tracked email activities (sent, delivered, opened, etc.) ‚Ä¢ 
                        <span class="font-semibold">Status Counts:</span> Based on latest email events from this sender
                    </div>
                </div>
            </div>
        </div>

    <!-- Email Sender Management section moved to its own page -->

        <!-- Campaign Setup -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Campaign Setup</h3>
        
        <!-- Contact Filter Selection -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Target Audience</label>
                <select id="contactFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="not_sent">üìß Not Sent Yet</option>
                    <option value="all">üë• All Contacts</option>
                    <option value="sent">üì§ Previously Sent</option>
                    <option value="delivered">‚úÖ Delivered</option>
                    <option value="opened">üëÅÔ∏è Opened</option>
                    <option value="clicked">üîó Clicked</option>
                    <option value="bounced">‚ö†Ô∏è Bounced</option>
                    <option value="failed">‚ùå Failed</option>
                    <option value="custom">üéØ Custom Selection</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Choose which contacts to target based on their engagement status</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
                <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">üìÅ All Categories</option>
                    <option disabled>Loading categories...</option>
                </select>
                <p class="text-sm text-gray-500 mt-2">Filter contacts by their assigned category</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Selection Range</label>
                <div class="grid grid-cols-2 gap-2">
                    <div class="relative">
                        <input type="number" id="contactRangeStart" min="1" placeholder="Start ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">From ID</label>
                    </div>
                    <div class="relative">
                        <input type="number" id="contactRangeEnd" min="1" placeholder="End ID" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                               onpaste="return false" onkeypress="return /[0-9]/.test(event.key)">
                        <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">To ID</label>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm text-gray-500">Select contacts by ID range (e.g., 1 to 100)</p>
                    <button type="button" id="clearRange" class="text-sm text-gray-400 hover:text-gray-600" title="Clear range">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p id="rangeError" class="text-sm text-red-500 mt-1 hidden">Invalid range specified</p>
                <div id="rangeInfo" class="text-sm text-blue-600 mt-1 hidden">
                    <span id="rangeCount">0</span> contacts in range
                </div>
            </div>
        </div>
        
        <!-- Email Subject -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Subject</label>
            <input type="text" id="emailSubject" value="EU Grant Advisory Platform - Beta Testing Invitation" 
                   class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Enter your email subject">
        </div>
        
        <!-- Custom Contact Selection (Hidden by default) -->
        <div id="customContactSelection" class="bg-gray-50 rounded-lg p-6 mb-6 hidden">
            <h4 class="text-lg font-medium text-gray-900 mb-4">üéØ Custom Contact Selection</h4>
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="contactSearch" placeholder="Search by name, email, company..." 
                           class="pl-10 w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <!-- Selection Controls -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex space-x-2">
                    <button type="button" id="selectAllFiltered" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200">
                        Select All Visible
                    </button>
                    <button type="button" id="deselectAll" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                        Deselect All
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
            
            <!-- Contacts List -->
            <div id="contactsList" class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                <div id="contactsLoading" class="p-4 text-center text-gray-500">
                    Loading contacts...
                </div>
            </div>
        </div>
        
        <!-- Email Template -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Template</label>
           
            <textarea id="emailTemplate" class="w-full"></textarea>
        </div>
        
        <!-- Send Button -->
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-500">
                <span id="csvStatus">Ready to send emails</span>
            </div>
            <button id="sendEmailsTracking" 
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Send Campaign</span>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="messages" class="mt-6"></div>
        </div>
    </div>

    <script>
        let columns = [];
        let editorInitialized = false;
        let allContacts = [];
        let filteredContacts = [];
        let selectedContacts = new Set();
        let isSenderSwitching = false; // Flag to prevent auto-save during sender switching

        // Initialize TinyMCE editor
        function initializeEditor() {
            // Check if TinyMCE is available
            if (typeof tinymce === 'undefined') {
                console.error('TinyMCE not loaded. Using fallback textarea.');
                return;
            }

            tinymce.init({
                selector: '#emailTemplate',
                height: 400,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | formatselect | ' +
                        'bold italic underline strikethrough | alignleft aligncenter ' +
                        'alignright alignjustify | outdent indent | numlist bullist | ' +
                        'forecolor backcolor removeformat | link table | ' +
                        'fontsize fontfamily | code preview help',
                font_family_formats: 'Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Georgia=georgia,palatino,serif; Helvetica=helvetica,arial,sans-serif; Times New Roman=times new roman,times,serif; Verdana=verdana,geneva,sans-serif',
                font_size_formats: '8pt 10pt 12pt 14pt 16pt 18pt 24pt 36pt 48pt',
                content_style: 'body { font-family:Arial,Helvetica,sans-serif; font-size:14px; margin: 16px; }',
                branding: false,
                promotion: false,
                setup: function (editor) {
                    editor.on('init', function () {
                        editorInitialized = true;
                        console.log('TinyMCE editor initialized successfully');
                        // Load template content after editor is ready
                        loadLastTemplate();
                    });
                }
            }).catch(function(error) {
                console.error('TinyMCE initialization failed:', error);
            });
        }

        // Load the last used template for a specific sender
        function loadLastTemplate(sender = null) {
            // Always use the currently selected sender from the dropdown
            const currentSender = document.getElementById('activeSenderSelect')?.value || sender || getSavedSender();
            
            if (!currentSender) {
                console.warn('‚ùå No sender available to load template');
                return;
            }
            
            console.log(`üîÑ LOADING TEMPLATE FOR SENDER: ${currentSender}`);
            console.log(`üìã Sender info:`, getSenderInfo(currentSender));
            
            // Clear the current cache for this template load
            const templateKey = `loadTemplate_${currentSender}`;
            if (window.lastTemplateLoadTime) {
                delete window.lastTemplateLoadTime[templateKey];
            }
            
            const apiUrl = `/api/get_template/?sender=${currentSender}`;
            console.log(`üåê Fetching template from: ${apiUrl}`);
            
            fetch(apiUrl)
                .then(response => {
                    console.log(`üì° Response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`üì¶ Template response data:`, data);
                    
                    if (data.error) {
                        console.log(`‚ö†Ô∏è No saved template found for sender ${currentSender}, using default`);
                        // Clear the fields if no template found
                        document.getElementById('emailSubject').value = '';
                        if (editorInitialized && tinymce.get('emailTemplate')) {
                            tinymce.get('emailTemplate').setContent('');
                        } else {
                            document.getElementById('emailTemplate').value = '';
                        }
                        return;
                    }
                    
                    console.log(`‚úÖ TEMPLATE LOADED for sender ${currentSender}:`);
                    console.log(`üìù Subject: "${data.subject}"`);
                    console.log(`üìÑ Content length: ${data.content ? data.content.length : 0} characters`);
                    
                    // Set the subject
                    document.getElementById('emailSubject').value = data.subject;
                    
                    // Set the template content
                    if (editorInitialized && tinymce.get('emailTemplate')) {
                        // TinyMCE is ready, set content through editor
                        tinymce.get('emailTemplate').setContent(data.content);
                        console.log(`üìù Content set via TinyMCE editor`);
                    } else {
                        // TinyMCE not ready yet, set textarea value directly
                        document.getElementById('emailTemplate').value = data.content;
                        console.log(`üìù Content set via textarea (TinyMCE not ready)`);
                        
                        // Also try to set it after a delay in case TinyMCE initializes later
                        setTimeout(() => {
                            if (tinymce.get('emailTemplate')) {
                                tinymce.get('emailTemplate').setContent(data.content);
                            }
                        }, 1000);
                    }
                    
                    console.log(`Successfully loaded template for sender: ${currentSender}`);
                })
                .catch(error => {
                    console.error('Failed to load template:', error);
                });
        }

        // Save the current template for a specific sender
        function saveCurrentTemplate(sender = null) {
            // Use the passed sender parameter if provided, otherwise get current sender
            console.log(`üîç saveCurrentTemplate() called with sender parameter: "${sender}"`);
            const currentSender = sender || document.getElementById('activeSenderSelect')?.value || getSavedSender();
            console.log(`üîç Resolved currentSender: "${currentSender}"`);
            console.log(`   - Dropdown value: "${document.getElementById('activeSenderSelect')?.value}"`);
            console.log(`   - getSavedSender(): "${getSavedSender()}"`);
            
            const subject = document.getElementById('emailSubject').value;
            
            console.log(`üíæ Saving template for sender: ${currentSender}, subject: "${subject}"`);
            
            let content = '';
            if (editorInitialized && tinymce.get('emailTemplate')) {
                content = tinymce.get('emailTemplate').getContent();
            } else {
                content = document.getElementById('emailTemplate').value;
            }
            
            if (!content.trim() && !subject.trim()) {
                console.log('‚ö†Ô∏è Skipping save - empty template');
                return; // Don't save empty templates
            }
            
            // Prevent duplicate saves with same content
            const templateKey = `${currentSender}_${subject}_${content}`;
            if (window.lastSavedTemplateKey === templateKey) {
                console.log('‚ö†Ô∏è Skipping save - same content as last save');
                return; // Same content, skip save
            }
            
            window.lastSavedTemplateKey = templateKey;
            
            fetch('/api/save_template/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: subject,
                    content: content,
                    sender: currentSender
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Failed to save template:', data.error);
                } else {
                    console.log(`Template saved for sender: ${currentSender}`);
                }
            })
            .catch(error => {
                console.error('Failed to save template:', error);
                // Reset the saved key so we can try again
                window.lastSavedTemplateKey = null;
            });
        }

        // Sender management functions
        function getSavedSender() {
            const savedSender = localStorage.getItem('selectedSender');
            console.log(`üîç getSavedSender() - localStorage value: "${savedSender}"`);
            
            // Always get the sender from the dropdown if available, else fallback to localStorage
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect && activeSenderSelect.value) {
                console.log(`üîç Current dropdown value: "${activeSenderSelect.value}"`);
                // Also update localStorage to keep it in sync
                if (activeSenderSelect.value !== localStorage.getItem('selectedSender')) {
                    localStorage.setItem('selectedSender', activeSenderSelect.value);
                    console.log(`üîÑ Synced localStorage to dropdown value: ${activeSenderSelect.value}`);
                }
                return activeSenderSelect.value;
            }
            console.log(`üîç No dropdown value, returning localStorage: ${savedSender}`);
            return savedSender || null;
        }

        function saveSender(sender) {
            console.log(`üíæ saveSender() - Saving sender: "${sender}"`);
            localStorage.setItem('selectedSender', sender);
            console.log(`‚úÖ Saved to localStorage: ${localStorage.getItem('selectedSender')}`);
            
            // Also update dropdown if it exists
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect && activeSenderSelect.value !== sender) {
                activeSenderSelect.value = sender;
                console.log(`üîÑ Updated dropdown to: ${sender}`);
            }
        }

        function getSavedCategory() {
            return localStorage.getItem('selectedCategory') || '';
        }

        function saveCategory(category) {
            localStorage.setItem('selectedCategory', category);
        }

        function applySenderToUI() {
            const savedSender = getSavedSender();
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                activeSenderSelect.value = savedSender;
            }
            
            // Update UI elements based on sender
            updateUIForSender(savedSender);
        }

        function applyCategoryToUI() {
            const savedCategory = getSavedCategory();
            const categorySelect = document.getElementById('categoryFilter');
            if (categorySelect && savedCategory) {
                categorySelect.value = savedCategory;
                // Trigger status message update to show the restored category selection
                updateStatusMessage();
            }
        }

        function updateUIForSender(sender) {
            // Update page title to show current sender
            const senderInfo = getSenderInfo(sender);
            document.title = `Email Campaign Manager - ${senderInfo.name}`;

            // Update the dropdown value if it exists
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                activeSenderSelect.value = sender;
                console.log(`ÔøΩ Set dropdown value to: ${sender}`);
                
                // Load the template for the selected sender
                loadLastTemplate(sender);
            }
        }

        // Async version of saveCurrentTemplate that returns a Promise
        function saveCurrentTemplateAsync(sender = null) {
            return new Promise((resolve) => {
                // Use the passed sender parameter if provided, otherwise get current sender
                const currentSender = sender || document.getElementById('activeSenderSelect')?.value || getSavedSender();
                const subject = document.getElementById('emailSubject').value;
                
                console.log(`üíæ ASYNC SAVING TEMPLATE:`);
                console.log(`   üë§ Sender: ${currentSender}`);
                console.log(`   üìù Subject: "${subject}"`);
                
                let content = '';
                if (editorInitialized && tinymce.get('emailTemplate')) {
                    content = tinymce.get('emailTemplate').getContent();
                    console.log(`   üìÑ Content (via TinyMCE): ${content.length} characters`);
                } else {
                    content = document.getElementById('emailTemplate').value;
                    console.log(`   üìÑ Content (via textarea): ${content.length} characters`);
                }
                
                if (!content.trim() && !subject.trim()) {
                    console.log('‚ö†Ô∏è Skipping async save - empty template');
                    resolve();
                    return;
                }
                
                const templateKey = `${currentSender}_${subject}_${content}`;
                if (window.lastSavedTemplateKey === templateKey) {
                    console.log('‚ö†Ô∏è Skipping async save - template unchanged');
                    resolve();
                    return;
                }
                window.lastSavedTemplateKey = templateKey;
                
                console.log(`üåê Posting template to /api/save_template/`);
                fetch('/api/save_template/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        content: content,
                        sender: currentSender
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Failed to save template:', data.error);
                    } else {
                        console.log(`Template saved for sender: ${currentSender}`);
                    }
                    resolve();
                })
                .catch(error => {
                    console.error('Failed to save template:', error);
                    window.lastSavedTemplateKey = null;
                    resolve();
                });
            });
            }
        

        // Global variable to store sender data
        let senderData = {};

        async function loadSenderData() {
            try {
                const response = await fetch('/api/get_senders/');
                const data = await response.json();
                if (data.senders) {
                    senderData = data.senders;
                    console.log('Loaded sender data:', senderData);
                } else {
                    console.error('No sender data received:', data);
                    senderData = {};
                }
            } catch (error) {
                console.error('Error loading sender data:', error);
                senderData = {};
            }
        }

        function getSenderInfo(sender) {
            return senderData[sender] || { name: 'Unknown', domain: 'unknown' };
        }

        // Load contact stats automatically on page load
        function loadContactStats(forceReload = false) {
            // Prevent excessive API calls with cooldown (but allow forced reloads)
            const now = Date.now();
            if (!forceReload && window.lastStatsLoadTime && (now - window.lastStatsLoadTime) < 2000) {
                console.log('Skipping stats reload - too frequent');
                return;
            }
            window.lastStatsLoadTime = now;
            
            // Show refresh indicator
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.classList.remove('hidden');
            }
            
            // Get current sender for filtering (always fresh from dropdown)
            const currentSender = getSavedSender();
            if (!currentSender) {
                console.warn('No sender selected, cannot load stats');
                document.getElementById('csvStatus').textContent = 'Please select a sender first';
                return;
            }
            
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            console.log(`Loading stats for sender: ${currentSender}, category: ${categoryFilter || 'All'}`);
            
            // Build URL with parameters and cache-busting timestamp
            let url = `/monitor/api/contact_stats/?sender=${currentSender}`;
            if (categoryFilter) {
                url += `&category=${encodeURIComponent(categoryFilter)}`;
            }
            // Add cache-busting parameter when force reloading
            if (forceReload) {
                url += `&_t=${Date.now()}`;
            }
            
            console.log('Loading stats with URL:', url);
            
            // Fetch contact statistics from our API with sender and category filter
            fetch(url, {
                // Disable caching for forced reloads
                cache: forceReload ? 'no-cache' : 'default',
                headers: {
                    'Cache-Control': forceReload ? 'no-cache' : 'default'
                }
            })
                .then(response => {
                    console.log('Stats API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Raw stats data received:', data);
                    if (data.error) {
                        document.getElementById('csvStatus').textContent = 'Error loading contact stats';
                        console.error('Contact stats error:', data.error);
                        return;
                    }
                    
                    // Store the stats globally for filter updates
                    window.contactStats = data;
                    
                    console.log('Stats updated for sender:', currentSender, {
                        category: data.category_filter || 'All Categories',
                        total_contacts: data.total_contacts,
                        not_sent: data.not_sent,
                        sent: data.sent,
                        delivered: data.delivered
                    });
                    
                    // Update the statistics cards
                    document.getElementById('totalContacts').textContent = data.total_contacts || 0;
                    document.getElementById('totalEmailEvents').textContent = data.total_email_events || 0;
                    document.getElementById('notSentContacts').textContent = data.not_sent || 0;
                    document.getElementById('sentContacts').textContent = data.sent || 0;
                    document.getElementById('deliveredContacts').textContent = data.delivered || 0;
                    document.getElementById('openedContacts').textContent = data.opened || 0;
                    document.getElementById('clickedContacts').textContent = data.clicked || 0;
                    document.getElementById('bouncedFailedContacts').textContent = (data.bounced || 0) + (data.failed || 0);
                    document.getElementById('complainedContacts').textContent = data.complained || 0;
                    document.getElementById('failedContacts').textContent = data.failed || 0;
                    
                    // Update status message based on current filter
                    updateStatusMessage();
                })
                .catch(error => {
                    document.getElementById('csvStatus').textContent = 'Ready to send emails';
                    console.error('Failed to load contact stats:', error);
                    
                    // Set default values
                    document.getElementById('totalContacts').textContent = '0';
                    document.getElementById('totalEmailEvents').textContent = '0';
                    document.getElementById('notSentContacts').textContent = '0';
                    document.getElementById('sentContacts').textContent = '0';
                    document.getElementById('deliveredContacts').textContent = '0';
                    document.getElementById('openedContacts').textContent = '0';
                    document.getElementById('clickedContacts').textContent = '0';
                    document.getElementById('bouncedFailedContacts').textContent = '0';
                    document.getElementById('complainedContacts').textContent = '0';
                    document.getElementById('failedContacts').textContent = '0';
                })
                .finally(() => {
                    // Hide refresh indicator
                    if (refreshIndicator) {
                        refreshIndicator.classList.add('hidden');
                    }
                });
        }

        // Load categories for the category filter dropdown
        function loadCategories() {
            fetch('/monitor/api/categories/')
                .then(response => response.json())
                .then(data => {
                    const categorySelect = document.getElementById('categoryFilter');
                    // Clear existing options except the first one
                    categorySelect.innerHTML = '<option value="">üìÅ All Categories</option>';
                    
                    if (data.success && data.categories && data.categories.length > 0) {
                        data.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.category_id;
                            option.textContent = `${category.category_name} (${category.category_id}) - ${category.contact_count} contacts`;
                            categorySelect.appendChild(option);
                        });
                        console.log('Loaded', data.categories.length, 'categories for email sending');
                        
                        // Restore saved category selection after loading categories
                        applyCategoryToUI();
                    } else {
                        console.log('No categories found for email sending');
                        // Add option indicating no categories
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No categories available yet';
                        option.disabled = true;
                        categorySelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading categories for email sending:', error);
                    const categorySelect = document.getElementById('categoryFilter');
                    categorySelect.innerHTML = '<option value="">üìÅ All Categories</option><option value="" disabled>Error loading categories</option>';
                });
        }

        // Update status message based on selected filter
        function updateStatusMessage() {
            if (!window.contactStats) return;
            
            const filter = document.getElementById('contactFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            // Handle custom selection differently
            if (filter === 'custom') {
                const selectedCount = selectedContacts.size;
                const categoryText = categoryFilter ? ` from category "${categoryFilter}"` : '';
                document.getElementById('csvStatus').textContent = selectedCount > 0 ? 
                    `Ready to send emails to ${selectedCount} selected contacts${categoryText}` : 
                    `Select contacts from the list below${categoryText}`;
                
                // Hide range controls for custom selection
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'none';
                return;
            } else {
                // Show range controls for other filters
                document.getElementById('contactRangeStart').closest('div').parentElement.style.display = 'block';
            }
            
            const stats = window.contactStats;
            const rangeStartInput = document.getElementById('contactRangeStart');
            const rangeEndInput = document.getElementById('contactRangeEnd');
            const rangeError = document.getElementById('rangeError');
            const rangeInfo = document.getElementById('rangeInfo');
            const rangeCount = document.getElementById('rangeCount');
            
            const startId = rangeStartInput.value ? parseInt(rangeStartInput.value) : null;
            const endId = rangeEndInput.value ? parseInt(rangeEndInput.value) : null;
            
            let count = 0;
            let filterName = '';
            
            switch(filter) {
                case 'all':
                    count = stats.total_contacts;
                    filterName = 'all contacts';
                    break;
                case 'not_sent':
                    count = stats.not_sent;
                    filterName = 'contacts not sent yet';
                    break;
                case 'sent':
                    count = stats.sent;
                    filterName = 'previously sent contacts';
                    break;
                case 'delivered':
                    count = stats.delivered;
                    filterName = 'delivered contacts';
                    break;
                case 'opened':
                    count = stats.opened;
                    filterName = 'opened contacts';
                    break;
                case 'clicked':
                    count = stats.clicked;
                    filterName = 'clicked contacts';
                    break;
                case 'bounced':
                    count = stats.bounced;
                    filterName = 'bounced contacts';
                    break;
                case 'failed':
                    count = stats.failed;
                    filterName = 'failed contacts';
                    break;
                case 'complained':
                    count = stats.complained;
                    filterName = 'complained contacts';
                    break;
                default:
                    count = stats.total_contacts;
                    filterName = 'contacts';
            }
            
            // Validate the range
            let isValidRange = true;
            let rangeSize = count;
            
            if (startId || endId) {
                // Check if both values are provided and valid
                if (startId && endId) {
                    if (startId > endId) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'Start ID must be less than or equal to End ID';
                        rangeInfo.classList.add('hidden');
                    } else if (startId < 1 || endId < 1) {
                        isValidRange = false;
                        rangeError.classList.remove('hidden');
                        rangeError.textContent = 'IDs must be greater than 0';
                        rangeInfo.classList.add('hidden');
                    } else {
                        rangeSize = endId - startId + 1;
                        rangeError.classList.add('hidden');
                        rangeInfo.classList.remove('hidden');
                        rangeCount.textContent = rangeSize;
                    }
                } else if (startId && !endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `${startId} onwards`;
                } else if (!startId && endId) {
                    rangeError.classList.add('hidden');
                    rangeInfo.classList.remove('hidden');
                    rangeCount.textContent = `1 to ${endId}`;
                    rangeSize = endId;
                }
                
                // Add visual feedback for inputs
                if (isValidRange) {
                    rangeStartInput.classList.remove('border-red-500');
                    rangeStartInput.classList.add('border-gray-300');
                    rangeEndInput.classList.remove('border-red-500');
                    rangeEndInput.classList.add('border-gray-300');
                } else {
                    rangeStartInput.classList.add('border-red-500');
                    rangeStartInput.classList.remove('border-gray-300');
                    rangeEndInput.classList.add('border-red-500');
                    rangeEndInput.classList.remove('border-gray-300');
                }
            } else {
                rangeError.classList.add('hidden');
                rangeInfo.classList.add('hidden');
                rangeStartInput.classList.remove('border-red-500');
                rangeStartInput.classList.add('border-gray-300');
                rangeEndInput.classList.remove('border-red-500');
                rangeEndInput.classList.add('border-gray-300');
            }
            
            // Update status message
            const categoryText = categoryFilter ? ` from category "${categoryFilter}"` : '';
            if (startId || endId) {
                if (isValidRange) {
                    if (startId && endId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID ${startId}-${endId} (${rangeSize} contacts) from ${filterName}${categoryText}`;
                    } else if (startId) {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts from ID ${startId} onwards from ${filterName}${categoryText}`;
                    } else {
                        document.getElementById('csvStatus').textContent = `Ready to send emails to contacts ID 1-${endId} from ${filterName}${categoryText}`;
                    }
                } else {
                    document.getElementById('csvStatus').textContent = `Invalid range specified for ${filterName}${categoryText}`;
                }
            } else {
                document.getElementById('csvStatus').textContent = `Ready to send emails to ${count} ${filterName}${categoryText}`;
            }
            
            // Store validation state globally
            window.isRangeValid = isValidRange;
        }

        // Load contacts for custom selection
        function loadContactsForSelection() {
            const currentSender = getSavedSender();
            
            fetch(`/monitor/api/contacts/?sender=${currentSender}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading contacts:', data.error);
                        return;
                    }
                    
                    allContacts = data.contacts || [];
                    filteredContacts = [...allContacts];
                    renderContactsList();
                })
                .catch(error => {
                    console.error('Failed to load contacts:', error);
                    document.getElementById('contactsLoading').textContent = 'Failed to load contacts';
                });
        }

        // Render contacts list
        function renderContactsList() {
            const contactsList = document.getElementById('contactsList');
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div class="p-4 text-center text-gray-500">No contacts found</div>';
                return;
            }
            
            const contactsHTML = filteredContacts.map(contact => {
                const isSelected = selectedContacts.has(contact.id);
                const statusColor = getStatusColor(contact.email_status);
                
                return `
                    <div class="contact-item p-3 border-b border-gray-200 hover:bg-gray-50 ${isSelected ? 'bg-blue-50' : ''}">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="contact_${contact.id}" 
                                   class="contact-checkbox mr-3" 
                                   ${isSelected ? 'checked' : ''}
                                   data-contact-id="${contact.id}">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-900">
                                            ${contact.first_name} ${contact.last_name}
                                        </p>
                                        <p class="text-sm text-gray-600">${contact.email}</p>
                                        ${contact.company_name ? `<p class="text-sm text-gray-500">${contact.company_name}</p>` : ''}
                                        ${contact.job_title ? `<p class="text-xs text-gray-400">${contact.job_title}</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                            ${contact.email_status.replace('_', ' ').toUpperCase()}
                                        </span>
                                        ${contact.location_country ? `<p class="text-xs text-gray-400 mt-1">${contact.location_country}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsList.innerHTML = contactsHTML;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const contactId = parseInt(this.dataset.contactId);
                    if (this.checked) {
                        selectedContacts.add(contactId);
                    } else {
                        selectedContacts.delete(contactId);
                    }
                    updateSelectedCount();
                    updateStatusMessage();
                });
            });
        }

        // Get status color for contact
        function getStatusColor(status) {
            switch(status) {
                case 'not_sent': return 'bg-gray-100 text-gray-800';
                case 'sent': return 'bg-blue-100 text-blue-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'opened': return 'bg-purple-100 text-purple-800';
                case 'clicked': return 'bg-indigo-100 text-indigo-800';
                case 'bounced': return 'bg-yellow-100 text-yellow-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'complained': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedContacts.size;
        }

        // Filter contacts based on search
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = [...allContacts];
            } else {
                const term = searchTerm.toLowerCase();
                filteredContacts = allContacts.filter(contact => 
                    contact.first_name.toLowerCase().includes(term) ||
                    contact.last_name.toLowerCase().includes(term) ||
                    contact.email.toLowerCase().includes(term) ||
                    (contact.company_name && contact.company_name.toLowerCase().includes(term)) ||
                    (contact.job_title && contact.job_title.toLowerCase().includes(term)) ||
                    (contact.location_country && contact.location_country.toLowerCase().includes(term))
                );
            }
            renderContactsList();
        }

        // Toggle custom contact selection visibility
        function toggleCustomSelection(show) {
            const customSection = document.getElementById('customContactSelection');
            if (show) {
                customSection.classList.remove('hidden');
                if (allContacts.length === 0) {
                    loadContactsForSelection();
                }
            } else {
                customSection.classList.add('hidden');
                selectedContacts.clear();
                updateSelectedCount();
            }
        }

        // Show message to user
        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageClass = isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700';
            messagesDiv.innerHTML = `<div class="${messageClass} px-4 py-3 rounded mb-4">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Load contacts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`üöÄ PAGE LOADED - Starting initialization`);
            
            // Load available senders first, then apply saved sender
            console.log(`üì° Loading available senders...`);
            loadAvailableSenders(); // This now loads both data and populates dropdown
            
            console.log(`üîß Initializing editor...`);
            initializeEditor();
            console.log(`üìä Loading contact stats...`);
            loadContactStats();
            console.log(`üìã Loading last template...`);
            loadLastTemplate();
            console.log(`üìÇ Loading categories...`);
            loadCategories(); // Load categories for the category filter
            console.log(`üë§ Loading email senders...`);
            loadEmailSenders(); // Load email senders for management
            
            // Set up periodic refresh of contact stats every 30 seconds
            setInterval(loadContactStats, 30000);
            
            // Manual refresh button
            const manualRefreshBtn = document.getElementById('manualRefresh');
            if (manualRefreshBtn) {
                manualRefreshBtn.addEventListener('click', function() {
                    loadContactStats();
                });
            }
            
            // Sender selection change handler (only if element exists)
            const senderSelect = document.getElementById('senderSelect');
            if (senderSelect) {
                senderSelect.addEventListener('change', function() {
                    const newSender = this.value;
                    console.log(`Switching to sender: ${newSender}`);
                    
                    // Save current template before switching
                    saveCurrentTemplate();
                    
                    // Update sender
                    saveSender(newSender);
                    updateUIForSender(newSender);
                    
                    // Load template for new sender
                    loadLastTemplate();
                    
                    // Refresh data for new sender
                    loadContactStats();
                    
                    // If custom selection is open, reload contacts for new sender
                    const customSection = document.getElementById('customContactSelection');
                    if (!customSection.classList.contains('hidden')) {
                        selectedContacts.clear();
                        updateSelectedCount();
                        loadContactsForSelection();
                    }
                    
                    console.log(`Successfully switched to sender: ${getSenderInfo(newSender).name}`);
                });
            }
            
            // Clear range button functionality
            const clearRangeBtn = document.getElementById('clearRange');
            if (clearRangeBtn) {
                clearRangeBtn.addEventListener('click', function() {
                    const startInput = document.getElementById('contactRangeStart');
                    const endInput = document.getElementById('contactRangeEnd');
                    if (startInput) startInput.value = '';
                    if (endInput) endInput.value = '';
                    updateStatusMessage();
                });
            }
            
            // Range input change handlers
            const contactRangeStart = document.getElementById('contactRangeStart');
            if (contactRangeStart) contactRangeStart.addEventListener('input', updateStatusMessage);
            const contactRangeEnd = document.getElementById('contactRangeEnd');
            if (contactRangeEnd) contactRangeEnd.addEventListener('input', updateStatusMessage);
            
            // Contact filter change handler
            const contactFilter = document.getElementById('contactFilter');
            if (contactFilter) {
                contactFilter.addEventListener('change', function() {
                    const isCustom = this.value === 'custom';
                    toggleCustomSelection(isCustom);
                    updateStatusMessage();
                });
            }
            
            // Category filter change handler
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    console.log('Category filter changed to:', this.value);
                    saveCategory(this.value); // Save the selected category
                    loadContactStats(true); // Force reload stats for the new category
                    updateStatusMessage();
                });
            }
            
            // Contact search handler
            const contactSearch = document.getElementById('contactSearch');
            if (contactSearch) {
                contactSearch.addEventListener('input', function() {
                    filterContacts(this.value);
                });
            }
            
            // Select all filtered contacts
            const selectAllFilteredBtn = document.getElementById('selectAllFiltered');
            if (selectAllFilteredBtn) {
                selectAllFilteredBtn.addEventListener('click', function() {
                    filteredContacts.forEach(contact => {
                        selectedContacts.add(contact.id);
                    });
                    renderContactsList();
                    updateSelectedCount();
                    updateStatusMessage();
                });
            }
            
            // Deselect all contacts

            const deselectAllBtn = document.getElementById('deselectAll');
            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', function() {
                    selectedContacts.clear();
                    renderContactsList();
                    updateSelectedCount();
                    updateStatusMessage();
                });
            }

            // Email Sender Management Event Listeners
            const addSenderBtn = document.getElementById('addSenderBtn');
            if (addSenderBtn) {
                addSenderBtn.addEventListener('click', function() {
                    showSenderModal();
                });
            }

            const exportSendersBtn = document.getElementById('exportSendersBtn');
            if (exportSendersBtn) {
                exportSendersBtn.addEventListener('click', function() {
                    exportSendersToJson();
                });
            }

            const importSendersBtn = document.getElementById('importSendersBtn');
            if (importSendersBtn) {
                importSendersBtn.addEventListener('click', function() {
                    showImportModal();
                });
            }

            const closeSenderModal = document.getElementById('closeSenderModal');
            if (closeSenderModal) {
                closeSenderModal.addEventListener('click', hideSenderModal);
            }

            const cancelSenderBtn = document.getElementById('cancelSenderBtn');
            if (cancelSenderBtn) {
                cancelSenderBtn.addEventListener('click', hideSenderModal);
            }

            const closeImportModal = document.getElementById('closeImportModal');
            if (closeImportModal) {
                closeImportModal.addEventListener('click', hideImportModal);
            }

            const cancelImportBtn = document.getElementById('cancelImportBtn');
            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', hideImportModal);
            }

            const importForm = document.getElementById('importForm');
            if (importForm) {
                importForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    importSendersFromJson();
                });
            }

            const senderForm = document.getElementById('senderForm');

            if (senderForm) {
                senderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const data = {};
                    // Convert FormData to regular object
                    for (let [key, value] of formData.entries()) {
                        if (key === 'is_active') {
                            data[key] = true; // Checkbox is checked
                        } else if (value.trim() !== '') {
                            data[key] = value.trim();
                        }
                    }
                    // If not checked, is_active should be false
                    if (!data.hasOwnProperty('is_active')) {
                        data.is_active = false;
                    }
                    // For editing, don't send empty API key or webhook secret
                    if (currentEditingSender && (!data.api_key || data.api_key === '')) {
                        delete data.api_key;
                    }
                    if (currentEditingSender && (!data.webhook_secret || data.webhook_secret === '')) {
                        delete data.webhook_secret;
                    }
                    saveEmailSender(data);
                });
            }

            const senderModal = document.getElementById('senderModal');
            if (senderModal) {
                senderModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideSenderModal();
                    }
                });
            }

            // Auto-save template when subject or content changes
            let autoSaveTimeout;
            let lastAutoSaveTime = 0;
            const AUTO_SAVE_COOLDOWN = 5000; // 5 seconds minimum between saves
            
            // Auto-save subject changes
            const emailSubject = document.getElementById('emailSubject');
            if (emailSubject) {
                emailSubject.addEventListener('input', function() {
                    if (isSenderSwitching) return; // Skip auto-save during sender switching
                    
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        const now = Date.now();
                        if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN && !isSenderSwitching) {
                            saveCurrentTemplate();
                            showAutoSaveIndicator();
                            lastAutoSaveTime = now;
                        }
                    }, 2000); // Save 2 seconds after user stops typing
                });
                // Also save subject when user clicks away (blur event)

                emailSubject.addEventListener('blur', function() {
                    if (isSenderSwitching) return; // Skip auto-save during sender switching
                    
                    clearTimeout(autoSaveTimeout);
                    if (Date.now() - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                        saveCurrentTemplate();
                        showAutoSaveIndicator();
                        lastAutoSaveTime = Date.now();
                    }
                });
            }
            
            // Auto-save template content changes (for TinyMCE)

            function setupAutoSaveForEditor() {
                if (editorInitialized && tinymce.get('emailTemplate')) {
                    tinymce.get('emailTemplate').on('input', function() {
                        if (isSenderSwitching) return; // Skip auto-save during sender switching
                        
                        clearTimeout(autoSaveTimeout);
                        autoSaveTimeout = setTimeout(() => {
                            const now = Date.now();
                            if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN && !isSenderSwitching) {
                                saveCurrentTemplate();
                                showAutoSaveIndicator();
                                lastAutoSaveTime = now;
                            }
                        }, 3000); // Save 3 seconds after user stops typing
                    });
                    // Also save on blur (when user clicks away)
                    tinymce.get('emailTemplate').on('blur', function() {
                        if (isSenderSwitching) return; // Skip auto-save during sender switching
                        
                        clearTimeout(autoSaveTimeout);
                        const now = Date.now();
                        if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                            saveCurrentTemplate();
                            showAutoSaveIndicator();
                            lastAutoSaveTime = now;
                        }
                    });
                } else {
                    // Retry setup if editor not ready yet
                    setTimeout(setupAutoSaveForEditor, 1000);
                }
            }
            
            // Set up auto-save when editor is ready
            setTimeout(setupAutoSaveForEditor, 2000);
        });

        // Send emails with tracking
        document.getElementById('sendEmailsTracking').addEventListener('click', function() {
            const contactFilter = document.getElementById('contactFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const subject = document.getElementById('emailSubject').value;
            const rangeStart = document.getElementById('contactRangeStart').value;
            const rangeEnd = document.getElementById('contactRangeEnd').value;
            
            // Handle custom selection
            if (contactFilter === 'custom') {
                if (selectedContacts.size === 0) {
                    showMessage('Please select at least one contact to send emails to', true);
                    return;
                }
            } else {
                // Validate range for non-custom filters
                if (!window.isRangeValid && (rangeStart || rangeEnd)) {
                    showMessage('Please enter a valid ID range', true);
                    return;
                }
            }
            
            // Get content from TinyMCE editor
            let template = '';
            if (editorInitialized && tinymce.get('emailTemplate')) {
                template = tinymce.get('emailTemplate').getContent();
                // Auto-save template when subject or content changes
                let autoSaveTimeout;
                let lastAutoSaveTime = 0;
                const AUTO_SAVE_COOLDOWN = 5000; // 5 seconds minimum between saves
                // Auto-save subject changes
                const emailSubject = document.getElementById('emailSubject');
                if (emailSubject) {
                    emailSubject.addEventListener('input', function() {
                        clearTimeout(autoSaveTimeout);
                        autoSaveTimeout = setTimeout(() => {
                            const now = Date.now();
                            if (now - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                                saveCurrentTemplate();
                                showAutoSaveIndicator();
                                lastAutoSaveTime = now;
                            }
                        }, 2000); // Save 2 seconds after user stops typing
                    });
                    // Also save subject when user clicks away (blur event)
                    emailSubject.addEventListener('blur', function() {
                        clearTimeout(autoSaveTimeout);
                        if (Date.now() - lastAutoSaveTime >= AUTO_SAVE_COOLDOWN) {
                            saveCurrentTemplate();
                            showAutoSaveIndicator();
                            lastAutoSaveTime = Date.now();
                        }
                    });
                }
            } else {
                template = document.getElementById('emailTemplate').value;
            }

            if (!template.trim() || template === '<p></p>') {
                showMessage('Please enter an email template', true);
                return;
            }

            // Show loading state
            const button = document.getElementById('sendEmailsTracking');
            const originalText = button.textContent;
            button.textContent = 'Sending Emails...';
            button.disabled = true;

            const requestBody = {
                template: template,
                subject: subject,
                sender: getSavedSender() // Use saved sender instead of dropdown value
            };
            
            // Add category filter if specified
            if (categoryFilter) {
                requestBody.category_filter = categoryFilter;
            }
            
            // Handle custom selection vs filter-based selection
            if (contactFilter === 'custom') {
                requestBody.selected_contact_ids = Array.from(selectedContacts);
            } else {
                requestBody.contact_filter = contactFilter;
                // Add range if specified and valid
                if ((rangeStart || rangeEnd) && window.isRangeValid) {
                    if (rangeStart) requestBody.contact_range_start = parseInt(rangeStart);
                    if (rangeEnd) requestBody.contact_range_end = parseInt(rangeEnd);
                }
            }

            fetch('/send_emails/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, true);
                } else {
                    let message = data.message;
                    if (data.failed_count > 0) {
                        message += `<br><strong>Failed emails:</strong> ${data.failed_count}`;
                        if (data.failed_emails && data.failed_emails.length > 0) {
                            message += '<br><small>' + data.failed_emails.slice(0, 3).join(', ') + '</small>';
                        }
                    }
                    showMessage(message);
                    
                    // Refresh contact stats after sending - use forced reloads to catch webhook updates
                    console.log('Emails sent successfully, refreshing stats...');
                    setTimeout(() => loadContactStats(true), 500);   // Quick refresh
                    setTimeout(() => loadContactStats(true), 2000);  // Medium refresh 
                    setTimeout(() => loadContactStats(true), 5000);  // Longer refresh to catch webhook updates
                    setTimeout(() => loadContactStats(true), 10000); // Final refresh for slow webhooks
                    
                    // If custom selection, refresh the contacts list to show updated status
                    if (contactFilter === 'custom') {
                        setTimeout(() => {
                            loadContactsForSelection();
                            selectedContacts.clear();
                            updateSelectedCount();
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                showMessage('Error: ' + error, true);
            })
            .finally(() => {
                // Reset button state
                button.textContent = originalText;
                button.disabled = false;
            });
        });

        // Function to navigate to contacts page with status filter
        function navigateToContactsWithStatus(status) {
            const currentSender = getSavedSender();
            const currentCategory = document.getElementById('categoryFilter').value;
            const url = new URL('/monitor/', window.location.origin);
            url.searchParams.set('status', status);
            url.searchParams.set('sender', currentSender);
            if (currentCategory) {
                url.searchParams.set('category', currentCategory);
            }
            window.location.href = url.toString();
        }

        // Function to update contacts link with current sender
        function updateContactsLinkWithSender(event, linkElement) {
            event.preventDefault();
            const currentSender = getSavedSender();
            const currentCategory = document.getElementById('categoryFilter').value;
            const url = new URL('/monitor/', window.location.origin);
            url.searchParams.set('sender', currentSender);
            if (currentCategory) {
                url.searchParams.set('category', currentCategory);
            }
            window.location.href = url.toString();
        }

        // Email Sender Management Functions
        let currentEditingSender = null;

        function loadEmailSenders() {
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayEmailSenders(data.senders);
                        updateSenderDropdowns(data.senders);
                    } else {
                        console.error('Failed to load email senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading email senders:', error);
                });
        }

        function displayEmailSenders(senders) {
            const container = document.getElementById('sendersContainer');
            if (!container) return;
            if (senders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>No email senders configured yet.</p>
                        <p class="text-sm">Click "Add New Sender" to create your first email configuration.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = senders.map(sender => `
                <div class="border border-gray-200 rounded-lg p-4 ${sender.is_active ? 'bg-white' : 'bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-medium text-gray-900">${sender.name}</h4>
                                <span class="px-2 py-1 text-xs rounded-full ${sender.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                    ${sender.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Key:</span> ${sender.key}
                            </p>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Email:</span> ${sender.email}
                            </p>
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-medium">Domain:</span> ${sender.domain}
                            </p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500 mt-2">
                                <span class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1 ${sender.has_api_key ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    API Key ${sender.has_api_key ? 'Set' : 'Missing'}
                                </span>
                                <span class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1 ${sender.has_webhook_url ? 'bg-green-500' : 'bg-gray-300'}"></div>
                                    Webhook ${sender.has_webhook_url ? 'Set' : 'Not Set'}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editSender(${sender.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Edit
                            </button>
                            <button onclick="deleteSender(${sender.id}, '${sender.name}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showSenderModal(sender = null) {
            currentEditingSender = sender;
            const modal = document.getElementById('senderModal');
            const title = document.getElementById('senderModalTitle');
            const form = document.getElementById('senderForm');
            
            if (sender) {
                title.textContent = 'Edit Email Sender';
                document.getElementById('senderKey').value = sender.key;
                document.getElementById('senderKey').disabled = true;
                document.getElementById('senderName').value = sender.name;
                document.getElementById('senderEmail').value = sender.email;
                document.getElementById('senderDomain').value = sender.domain;
                document.getElementById('senderIsActive').checked = sender.is_active;
                document.getElementById('senderApiKey').placeholder = 'Leave blank to keep current key';
                document.getElementById('senderWebhookSecret').placeholder = 'Leave blank to keep current secret';
            } else {
                title.textContent = 'Add Email Sender';
                form.reset();
                document.getElementById('senderKey').disabled = false;
                document.getElementById('senderApiKey').placeholder = 're_...';
                document.getElementById('senderWebhookSecret').placeholder = 'whsec_...';
            }
            
            modal.classList.remove('hidden');
        }

        function hideSenderModal() {
            document.getElementById('senderModal').classList.add('hidden');
            document.getElementById('senderForm').reset();
            currentEditingSender = null;
        }

        function editSender(senderId) {
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const sender = data.senders.find(s => s.id === senderId);
                        if (sender) {
                            showSenderModal(sender);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching sender:', error);
                    alert('Error loading sender details');
                });
        }

        function deleteSender(senderId, senderName) {
            if (confirm(`Are you sure you want to delete the email sender "${senderName}"?`)) {
                fetch(`/monitor/api/email_senders/${senderId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadEmailSenders(); // Reload the sender management list
                        loadAvailableSenders(); // Refresh the dropdown options
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting sender:', error);
                    alert('Error deleting sender');
                });
            }
        }

        function updateSenderDropdowns(senders) {
            // Update main sender selector if it exists
            const senderSelect = document.getElementById('senderSelect');
            if (senderSelect) {
                const currentValue = senderSelect.value;
                senderSelect.innerHTML = senders
                    .filter(sender => sender.is_active)
                    .map(sender => `<option value="${sender.key}">${sender.name}</option>`)
                    .join('');
                
                // Restore previous selection if still available
                if (currentValue && senders.find(s => s.key === currentValue && s.is_active)) {
                    senderSelect.value = currentValue;
                }
            }

            // Update active sender select
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                const currentValue = activeSenderSelect.value;
                activeSenderSelect.innerHTML = senders
                    .filter(sender => sender.is_active)
                    .map(sender => `<option value="${sender.key}">${sender.name}</option>`)
                    .join('');
                
                // Restore previous selection if still available
                if (currentValue && senders.find(s => s.key === currentValue && s.is_active)) {
                    activeSenderSelect.value = currentValue;
                }
            }
        }

        function loadAvailableSenders() {
            console.log(`üì° loadAvailableSenders() - Fetching from /api/get_senders/`);
            fetch('/api/get_senders/')
                .then(response => {
                    console.log(`üì° Response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`üì¶ Received sender data:`, data);
                    if (data.senders) {
                        senderData = data.senders;
                        console.log(`‚úÖ Stored senderData:`, senderData);
                        console.log(`üë• Available senders: ${Object.keys(senderData).join(', ')}`);
                        updateSenderDropdownsFromAvailable(data.senders);
                    } else {
                        console.error('‚ùå Failed to load available senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading available senders:', error);
                });
        }

        function updateSenderDropdownsFromAvailable(senders) {
            // Update active sender select - convert dictionary to array
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                const currentValue = activeSenderSelect.value;
                const senderKeys = Object.keys(senders);
                console.log('Updating sender dropdown with senders:', senders);
                console.log('Current dropdown value before update:', currentValue);
                
                activeSenderSelect.innerHTML = senderKeys
                    .map(key => {
                        const sender = senders[key];
                        console.log(`üìã Sender data for ${key}:`, sender);
                        // Always show format: "Name (email)" for consistency with contacts page
                        const displayName = sender.name && sender.name !== sender.email 
                            ? `${sender.name} (${sender.email})` 
                            : sender.email;
                        console.log(`üìã Creating option: ${key} -> "${displayName}"`);
                        console.log(`   - display_name: "${sender.display_name}"`);
                        console.log(`   - name: "${sender.name}"`);
                        console.log(`   - email: "${sender.email}"`);
                        return `<option value="${key}">${displayName}</option>`;
                    })
                    .join('');
                    
                // Set saved sender or default to first available
                const savedSender = localStorage.getItem('selectedSender'); // Get raw localStorage value
                console.log('Saved sender from localStorage:', savedSender);
                console.log('Available sender keys:', senderKeys);
                console.log('Is saved sender available?', savedSender && senders[savedSender]);
                
                if (savedSender && senders[savedSender]) {
                    activeSenderSelect.value = savedSender;
                    console.log(`‚úÖ Set saved sender: ${savedSender}`);
                } else if (senderKeys.length > 0) {
                    activeSenderSelect.value = senderKeys[0];
                    saveSender(senderKeys[0]); // Save the default selection
                    console.log(`‚ö†Ô∏è Saved sender "${savedSender}" not found, set default sender: ${senderKeys[0]}`);
                } else {
                    console.log('‚ùå No senders available');
                }
                
                console.log('Final dropdown value:', activeSenderSelect.value);
                console.log('Final dropdown HTML:', activeSenderSelect.innerHTML);
                console.log('Final dropdown options:', Array.from(activeSenderSelect.options).map(opt => `${opt.value}: "${opt.text}"`));
                
                // Add a mutation observer to detect if dropdown gets modified
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            console.log('üö® DROPDOWN MODIFIED after initial setup!');
                            console.log('New dropdown HTML:', activeSenderSelect.innerHTML);
                            console.log('New dropdown options:', Array.from(activeSenderSelect.options).map(opt => `${opt.value}: "${opt.text}"`));
                        }
                    });
                });
                observer.observe(activeSenderSelect, { childList: true, subtree: true, characterData: true });
                
                // Attach the change event listener here after dropdown is populated
                console.log(`üéß Attaching change event listener to sender dropdown`);
                if (activeSenderSelect._listener) {
                    activeSenderSelect.removeEventListener('change', activeSenderSelect._listener);
                    console.log(`üóëÔ∏è Removed old event listener`);
                }
                
                activeSenderSelect._listener = function() {
                    const oldSender = localStorage.getItem('selectedSender'); // Get from localStorage, not dropdown
                    const newSender = this.value;
                    
                    console.log(`üîÑ SENDER CHANGE DETECTED:`);
                    console.log(`   üì§ Old sender: ${oldSender} (${getSenderInfo(oldSender).name})`);
                    console.log(`   üì• New sender: ${newSender} (${getSenderInfo(newSender).name})`);
                    
                    // Don't do anything if the sender hasn't actually changed
                    if (oldSender === newSender) {
                        console.log(`‚ö†Ô∏è No actual change detected (${oldSender} === ${newSender}), ignoring`);
                        return;
                    }
                    
                    // Prevent event bubbling during switching
                    isSenderSwitching = true;
                    console.log(`üö´ Set isSenderSwitching = true`);
                    
                    // Save current template for old sender explicitly before switching
                    console.log(`üíæ Saving current template for old sender: ${oldSender}`);
                    saveCurrentTemplateAsync(oldSender).then(() => {
                        console.log(`‚úÖ Template saved for ${oldSender}, now switching to ${newSender}`);
                        
                        // Now switch to new sender
                        saveSender(newSender);
                        console.log(`üîß Updated localStorage to new sender: ${newSender}`);
                        
                        // Clear current content before loading new template
                        console.log(`üßπ Clearing current template content`);
                        document.getElementById('emailSubject').value = '';
                        if (editorInitialized && tinymce.get('emailTemplate')) {
                            tinymce.get('emailTemplate').setContent('');
                        } else {
                            document.getElementById('emailTemplate').value = '';
                        }
                        
                        // Force reload the template for the new sender
                        console.log(`üìã Loading template for new sender: ${newSender}`);
                        loadLastTemplate(newSender);
                        
                        // Refresh contact stats for new sender
                        loadContactStats(true); // Force reload
                        
                        // If custom selection is open, reload contacts for new sender
                        const customSection = document.getElementById('customContactSelection');
                        if (customSection && !customSection.classList.contains('hidden')) {
                            selectedContacts.clear();
                            updateSelectedCount();
                            loadContactsForSelection();
                        }
                        console.log(`üéâ Successfully switched from ${getSenderInfo(oldSender).name} to ${getSenderInfo(newSender).name}`);
                        
                        // Clear the switching flag after a delay to allow template to load
                        setTimeout(() => {
                            isSenderSwitching = false;
                            console.log(`‚úÖ Set isSenderSwitching = false`);
                        }, 1000);
                    });
                };
                
                activeSenderSelect.addEventListener('change', activeSenderSelect._listener);
                console.log(`‚úÖ Event listener attached to sender dropdown`);
                
                // Always load the template for the selected sender after a short delay
                setTimeout(() => {
                    const finalSender = activeSenderSelect.value;
                    console.log(`Initial template load for sender: ${finalSender}`);
                    loadLastTemplate(finalSender);
                }, 500);
            }
        }

        function saveEmailSender(formData) {
            const isEditing = currentEditingSender !== null;
            const url = isEditing 
                ? `/monitor/api/email_senders/${currentEditingSender.id}/update/`
                : '/monitor/api/email_senders/create/';
            const method = isEditing ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    hideSenderModal();
                    loadEmailSenders(); // Reload the sender management list
                    loadAvailableSenders(); // Refresh the dropdown options
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving sender:', error);
                alert('Error saving sender');
            });
        }

        // JSON Import/Export Functions
        function exportSendersToJson() {
            fetch('/monitor/api/email_senders/export/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create downloadable JSON file
                        const jsonString = JSON.stringify(data.senders, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        // Create download link
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `email_senders_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Email senders exported successfully!');
                    } else {
                        alert('Error exporting email senders: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error exporting email senders:', error);
                    alert('Error exporting email senders');
                });
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            // Clear previous data
            document.getElementById('jsonImportData').value = '';
            document.getElementById('replaceExisting').checked = false;
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function importSendersFromJson() {
            const jsonData = document.getElementById('jsonImportData').value.trim();
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!jsonData) {
                alert('Please enter JSON data');
                return;
            }
            
            try {
                // Validate JSON format
                const parsedData = JSON.parse(jsonData);
                
                // Prepare the data for import
                const importData = {
                    senders: parsedData.senders || parsedData, // Support both formats
                    replace_existing: replaceExisting
                };
                
                // Validate that we have senders data
                if (!importData.senders || Object.keys(importData.senders).length === 0) {
                    alert('No valid senders data found in JSON');
                    return;
                }
                
                // Send import request
                fetch('/monitor/api/email_senders/import/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(importData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hideImportModal();
                        loadEmailSenders(); // Reload the sender management list
                        loadAvailableSenders(); // Refresh the dropdown options
                        
                        let message = data.message;
                        if (data.errors && data.errors.length > 0) {
                            message += '\n\nErrors encountered:\n' + data.errors.join('\n');
                        }
                        alert(message);
                    } else {
                        alert('Error importing senders: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error importing senders:', error);
                    alert('Error importing senders');
                });
                
            } catch (e) {
                alert('Invalid JSON format: ' + e.message);
            }
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.split('; ')
                           .find(row => row.startsWith('csrftoken='))
                           ?.split('=')[1] || '';
        }

    // Show auto-save indicator (fix for missing function)
    function showAutoSaveIndicator() {
        const indicator = document.getElementById('autoSaveIndicator');
        if (indicator) {
            indicator.classList.remove('hidden');
            // Optionally update text if needed
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 1200);
        }
    }
    </script>

</body>
</html>
