{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sender Management</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}?v=20250811">
    <link rel="alternate icon" href="{% static 'favicon.ico' %}?v=20250811">
    <link rel="mask-icon" href="{% static 'favicon.svg' %}?v=20250811" color="#3B82F6">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
</head>
<body class="bg-gray-100 pb-12">
    <!-- Navigation -->
    <nav class="bg-white shadow mb-6">
        <div class="max-w-4xl mx-auto px-6">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Email Templater</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">Send Emails</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sender Selector -->
    <div id="senderIndicator" class="bg-blue-50 border border-blue-200 rounded-lg shadow-sm p-4 mb-6 max-w-6xl mx-auto">
        <div class="flex items-center space-x-4">
            <div class="p-2 bg-blue-100 rounded-lg flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-blue-900 mb-1">Active Sender Account</p>
                <select id="activeSenderSelect" class="w-full text-lg font-semibold text-blue-700 bg-white border border-blue-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer hover:bg-blue-50 transition-colors min-w-max">
                    <option value="">Loading senders...</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Email Sender Management Section -->
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Email Sender Management</h3>
                <div class="flex space-x-3">
                    <button id="exportSendersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Export JSON</span>
                    </button>
                    <button id="importSendersBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>Import JSON</span>
                    </button>
                    <button id="addSenderBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Add New Sender</span>
                    </button>
                </div>
            </div>
            <div id="sendersContainer" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    Loading email senders...
                </div>
            </div>
        </div>
    </div>

    <!-- Email Sender Modal -->
    <div id="senderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="senderModalTitle" class="text-lg font-medium text-gray-900">Add Email Sender</h3>
                <button id="closeSenderModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="senderForm" class="space-y-4">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="senderKey" class="block text-sm font-medium text-gray-700">Sender Key</label>
                        <input type="text" id="senderKey" name="key" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Unique identifier for this sender</p>
                    </div>
                    <div>
                        <label for="senderName" class="block text-sm font-medium text-gray-700">Sender Name</label>
                        <input type="text" id="senderName" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Display name for the sender</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="senderEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="senderEmail" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Email address to send from</p>
                    </div>
                    <div>
                        <label for="senderDomain" class="block text-sm font-medium text-gray-700">Domain</label>
                        <input type="text" id="senderDomain" name="domain" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Email service domain</p>
                    </div>
                </div>
                <div>
                    <label for="senderApiKey" class="block text-sm font-medium text-gray-700">API Key</label>
                    <input type="password" id="senderApiKey" name="api_key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">API key for the email service</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="senderWebhookUrl" class="block text-sm font-medium text-gray-700">Webhook URL</label>
                        <input type="url" id="senderWebhookUrl" name="webhook_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Optional webhook URL</p>
                    </div>
                    <div>
                        <label for="senderWebhookSecret" class="block text-sm font-medium text-gray-700">Webhook Secret</label>
                        <input type="password" id="senderWebhookSecret" name="webhook_secret" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <p class="mt-1 text-xs text-gray-500">Optional webhook secret</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="senderIsActive" name="is_active" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="senderIsActive" class="ml-2 block text-sm text-gray-900">Active</label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelSenderBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Save Sender
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Senders Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Import Email Senders</h3>
                <button id="closeImportModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Import Method Selection -->
            <div class="mb-4">
                <div class="flex border-b border-gray-200">
                    <button id="fileImportTab" class="py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-t-lg">
                        Upload File
                    </button>
                    <button id="textImportTab" class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-t-lg">
                        Paste JSON
                    </button>
                </div>
            </div>

            <form id="importForm" class="space-y-4">
                {% csrf_token %}
                
                <!-- File Upload Tab -->
                <div id="fileImportContent">
                    <div>
                        <label for="importFile" class="block text-sm font-medium text-gray-700">Select JSON File</label>
                        <input type="file" id="importFile" name="import_file" accept=".json" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="mt-1 text-xs text-gray-500">Upload a JSON file with email sender configurations</p>
                    </div>
                </div>

                <!-- Text Paste Tab -->
                <div id="textImportContent" class="hidden">
                    <div>
                        <label for="importText" class="block text-sm font-medium text-gray-700">Paste JSON Configuration</label>
                        <textarea id="importText" name="import_text" rows="15" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-mono text-sm" placeholder='Paste your JSON here, example:
{
  "senders": {
    "horizoneurope": {
      "email": "roland.zonai@horizoneurope.io",
      "name": "Roland Zonai - Horizon Europe IO",
      "api_key": "re_Cs5WjBoq_KQVASjgHeJv5ru1Nkuomk3BY",
      "domain": "horizoneurope.io",
      "webhook_url": "sender.horizoneurope.io/webhook1/",
      "webhook_secret": "whsec_mxDD0UTbIirVJ1//WCon4NpRz4e0jotf"
    },
    "horizon_eu": {
      "email": "roland.zonai@horizon.eu.com",
      "name": "Roland Zonai - Horizon EU",
      "api_key": "re_2g11XipG_PZyEkMWAkwJ2eTSMbZVbk5hz",
      "domain": "horizon.eu.com",
      "webhook_url": "sender.horizoneurope.io/webhook2/",
      "webhook_secret": "whsec_tAU54drStmKUyqSmDT2An08p0m3WuvSv"
    }
  },
  "replace_existing": false
}'></textarea>
                        <p class="mt-1 text-xs text-gray-500">Paste your JSON sender configurations directly here</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelImportBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        Import Senders
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentEditingSender = null;

        // Load available senders for dropdown
        function loadAvailableSenders() {
            console.log('📡 Loading available senders for dropdown...');
            fetch('/monitor/api/email_senders/available/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('📡 Available senders loaded:', data.senders);
                        updateSenderDropdownsFromAvailable(data.senders);
                    } else {
                        console.error('Failed to load available senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading available senders:', error);
                });
        }

        function updateSenderDropdownsFromAvailable(senders) {
            console.log('🔄 Updating sender dropdowns with available senders:', senders);
            const activeSenderSelect = document.getElementById('activeSenderSelect');
            if (activeSenderSelect) {
                const currentValue = activeSenderSelect.value;
                activeSenderSelect.innerHTML = senders
                    .filter(sender => sender.key)
                    .map(sender => `<option value="${sender.key}">${sender.display_name}</option>`)
                    .join('');
                
                // Restore previous selection if still available
                if (currentValue && senders.find(s => s.key === currentValue)) {
                    activeSenderSelect.value = currentValue;
                } else if (senders.length > 0) {
                    // Select first sender if none selected
                    activeSenderSelect.value = senders[0].key;
                }
                console.log('🔄 Updated activeSenderSelect, current value:', activeSenderSelect.value);
            }
        }

        // Load all email senders for management
        function loadEmailSenders() {
            console.log('📋 Loading email senders for management...');
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    console.log('📋 Email senders response:', data);
                    if (data.success) {
                        console.log('📋 Rendering senders:', data.senders);
                        renderEmailSenders(data.senders);
                    } else {
                        console.error('Failed to load email senders:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading email senders:', error);
                });
        }

        function renderEmailSenders(senders) {
            const container = document.getElementById('sendersContainer');
            if (senders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No email senders configured yet.</p>
                        <button onclick="showSenderModal()" class="mt-2 text-blue-500 hover:text-blue-700">Add your first sender</button>
                    </div>
                `;
                return;
            }

            const sendersHtml = senders.map(sender => `
                <div class="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full ${sender.is_active ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full ${sender.is_active ? 'bg-green-500' : 'bg-red-500'}"></div>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-lg font-medium text-gray-900">${sender.name}</h4>
                                <p class="text-sm text-gray-500">${sender.email}</p>
                                <p class="text-xs text-gray-400">Key: ${sender.key} | Domain: ${sender.domain}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full ${sender.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${sender.is_active ? 'Active' : 'Inactive'}
                        </span>
                        <div class="flex space-x-1">
                            <button onclick="editSender(${sender.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Edit
                            </button>
                            <button onclick="deleteSender(${sender.id}, '${sender.name}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = sendersHtml;
        }

        function showSenderModal(sender = null) {
            currentEditingSender = sender;
            const modal = document.getElementById('senderModal');
            const title = document.getElementById('senderModalTitle');
            const form = document.getElementById('senderForm');
            
            if (sender) {
                title.textContent = 'Edit Email Sender';
                // Pre-fill form with sender data
                document.getElementById('senderKey').value = sender.key;
                document.getElementById('senderKey').disabled = true; // Don't allow key changes
                document.getElementById('senderName').value = sender.name;
                document.getElementById('senderEmail').value = sender.email;
                document.getElementById('senderDomain').value = sender.domain;
                document.getElementById('senderWebhookUrl').value = sender.webhook_url || '';
                document.getElementById('senderIsActive').checked = sender.is_active;
                // Don't pre-fill sensitive fields like API key and webhook secret
                document.getElementById('senderApiKey').placeholder = 'Leave blank to keep current API key';
                document.getElementById('senderWebhookSecret').placeholder = 'Leave blank to keep current webhook secret';
            } else {
                title.textContent = 'Add Email Sender';
                form.reset();
                document.getElementById('senderKey').disabled = false;
                document.getElementById('senderApiKey').placeholder = '';
                document.getElementById('senderWebhookSecret').placeholder = '';
                document.getElementById('senderIsActive').checked = true;
            }
            
            modal.classList.remove('hidden');
        }

        function hideSenderModal() {
            document.getElementById('senderModal').classList.add('hidden');
            currentEditingSender = null;
        }

        function editSender(senderId) {
            // Find sender in the current list
            fetch('/monitor/api/email_senders/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const sender = data.senders.find(s => s.id === senderId);
                        if (sender) {
                            showSenderModal(sender);
                        }
                    }
                });
        }

        function deleteSender(senderId, senderName) {
            if (confirm(`Are you sure you want to delete the email sender "${senderName}"?`)) {
                fetch(`/monitor/api/email_senders/${senderId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEmailSenders(); // Reload the list
                        loadAvailableSenders(); // Refresh dropdown
                        alert(data.message);
                    } else {
                        alert('Error deleting sender: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting sender:', error);
                    alert('Error deleting sender');
                });
            }
        }

        function saveEmailSender(data) {
            console.log('💾 Saving email sender with data:', data);
            console.log('💾 Current editing sender:', currentEditingSender);
            
            const url = currentEditingSender 
                ? `/monitor/api/email_senders/${currentEditingSender.id}/update/`
                : '/monitor/api/email_senders/create/';
            const method = currentEditingSender ? 'PUT' : 'POST';

            console.log('💾 Making request to:', url, 'with method:', method);

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('💾 Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('💾 Response data:', data);
                if (data.success) {
                    hideSenderModal();
                    console.log('💾 Reloading email senders list...');
                    // Add a small delay to ensure database transaction is complete
                    setTimeout(() => {
                        loadEmailSenders(); // Reload the list
                        console.log('💾 Reloading available senders dropdown...');
                        loadAvailableSenders(); // Refresh dropdown
                    }, 500);
                    alert(data.message);
                } else {
                    alert('Error saving sender: ' + data.error);
                }
            })
            .catch(error => {
                console.error('💾 Error saving sender:', error);
                alert('Error saving sender');
            });
        }

        function exportSendersToJson() {
            fetch('/monitor/api/email_senders/export/')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Export failed');
                        });
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'email_senders.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('Email senders exported successfully!');
                })
                .catch(error => {
                    console.error('Error exporting email senders:', error);
                    alert('Error exporting email senders: ' + error.message);
                });
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            // Reset to file tab by default
            switchToFileImport();
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            // Clear form data
            document.getElementById('importFile').value = '';
            document.getElementById('importText').value = '';
        }

        function switchToFileImport() {
            // Update tab appearance
            document.getElementById('fileImportTab').classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
            document.getElementById('fileImportTab').classList.remove('text-gray-500');
            document.getElementById('textImportTab').classList.add('text-gray-500');
            document.getElementById('textImportTab').classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
            
            // Show/hide content
            document.getElementById('fileImportContent').classList.remove('hidden');
            document.getElementById('textImportContent').classList.add('hidden');
            
            // Update required fields
            document.getElementById('importFile').required = true;
            document.getElementById('importText').required = false;
        }

        function switchToTextImport() {
            // Update tab appearance
            document.getElementById('textImportTab').classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
            document.getElementById('textImportTab').classList.remove('text-gray-500');
            document.getElementById('fileImportTab').classList.add('text-gray-500');
            document.getElementById('fileImportTab').classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
            
            // Show/hide content
            document.getElementById('textImportContent').classList.remove('hidden');
            document.getElementById('fileImportContent').classList.add('hidden');
            
            // Update required fields
            document.getElementById('importText').required = true;
            document.getElementById('importFile').required = false;
        }

        function importSendersFromJson() {
            const fileInput = document.getElementById('importFile');
            const textInput = document.getElementById('importText');
            const isFileMode = !document.getElementById('fileImportContent').classList.contains('hidden');
            
            if (isFileMode) {
                // File mode
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a file to import');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        sendImportData(importData);
                    } catch (e) {
                        alert('Invalid JSON format in file: ' + e.message);
                    }
                };
                reader.readAsText(file);
            } else {
                // Text mode
                const jsonText = textInput.value.trim();
                if (!jsonText) {
                    alert('Please paste JSON configuration');
                    return;
                }
                
                try {
                    const importData = JSON.parse(jsonText);
                    sendImportData(importData);
                } catch (e) {
                    alert('Invalid JSON format: ' + e.message);
                }
            }
        }

        function sendImportData(importData) {
            fetch('/monitor/api/email_senders/import/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(importData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideImportModal();
                    loadEmailSenders(); // Reload the sender management list
                    loadAvailableSenders(); // Refresh the dropdown options
                    
                    let message = data.message;
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\nErrors encountered:\n' + data.errors.join('\n');
                    }
                    alert(message);
                } else {
                    alert('Error importing senders: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error importing senders:', error);
                alert('Error importing senders');
            });
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.split('; ')
                           .find(row => row.startsWith('csrftoken='))
                           ?.split('=')[1] || '';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadAvailableSenders();
            loadEmailSenders();

            // Add Sender Button
            const addSenderBtn = document.getElementById('addSenderBtn');
            if (addSenderBtn) {
                addSenderBtn.addEventListener('click', function() {
                    showSenderModal();
                });
            }

            // Export Button
            const exportSendersBtn = document.getElementById('exportSendersBtn');
            if (exportSendersBtn) {
                exportSendersBtn.addEventListener('click', function() {
                    exportSendersToJson();
                });
            }

            // Import Button
            const importSendersBtn = document.getElementById('importSendersBtn');
            if (importSendersBtn) {
                importSendersBtn.addEventListener('click', function() {
                    showImportModal();
                });
            }

            // Modal close buttons
            const closeSenderModal = document.getElementById('closeSenderModal');
            if (closeSenderModal) {
                closeSenderModal.addEventListener('click', hideSenderModal);
            }

            const cancelSenderBtn = document.getElementById('cancelSenderBtn');
            if (cancelSenderBtn) {
                cancelSenderBtn.addEventListener('click', hideSenderModal);
            }

            const closeImportModal = document.getElementById('closeImportModal');
            if (closeImportModal) {
                closeImportModal.addEventListener('click', hideImportModal);
            }

            const cancelImportBtn = document.getElementById('cancelImportBtn');
            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', hideImportModal);
            }

            // Import tab switching
            const fileImportTab = document.getElementById('fileImportTab');
            if (fileImportTab) {
                fileImportTab.addEventListener('click', switchToFileImport);
            }

            const textImportTab = document.getElementById('textImportTab');
            if (textImportTab) {
                textImportTab.addEventListener('click', switchToTextImport);
            }

            // Form submissions
            const senderForm = document.getElementById('senderForm');
            if (senderForm) {
                senderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const data = {};
                    
                    // Convert FormData to regular object
                    for (let [key, value] of formData.entries()) {
                        if (key === 'is_active') {
                            data[key] = true; // Checkbox is checked
                        } else if (value.trim() !== '') {
                            data[key] = value.trim();
                        }
                    }
                    
                    // If not checked, is_active should be false
                    if (!data.hasOwnProperty('is_active')) {
                        data.is_active = false;
                    }
                    
                    // For editing, don't send empty API key or webhook secret
                    if (currentEditingSender && (!data.api_key || data.api_key === '')) {
                        delete data.api_key;
                    }
                    if (currentEditingSender && (!data.webhook_secret || data.webhook_secret === '')) {
                        delete data.webhook_secret;
                    }
                    
                    saveEmailSender(data);
                });
            }

            const importForm = document.getElementById('importForm');
            if (importForm) {
                importForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    importSendersFromJson();
                });
            }

            // Modal backdrop clicks
            const senderModal = document.getElementById('senderModal');
            if (senderModal) {
                senderModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideSenderModal();
                    }
                });
            }

            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideImportModal();
                    }
                });
            }
        });
    </script>
    <!-- TODO: Add sender management modals and JS here (reuse from index.html) -->
</body>
</html>
